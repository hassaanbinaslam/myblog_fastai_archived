<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Deploy Scikit-learn Models to Amazon SageMaker with the SageMaker Python SDK using Script mode | Random Thoughts</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Deploy Scikit-learn Models to Amazon SageMaker with the SageMaker Python SDK using Script mode" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The aim of this notebook is to demonstrate how to train and deploy a scikit-learn model in Amazon SageMaker using script mode." />
<meta property="og:description" content="The aim of this notebook is to demonstrate how to train and deploy a scikit-learn model in Amazon SageMaker using script mode." />
<link rel="canonical" href="https://hassaanbinaslam.github.io/myblog/aws/ml/sagemaker/2022/07/07/sagemaker-script-mode.html" />
<meta property="og:url" content="https://hassaanbinaslam.github.io/myblog/aws/ml/sagemaker/2022/07/07/sagemaker-script-mode.html" />
<meta property="og:site_name" content="Random Thoughts" />
<meta property="og:image" content="https://hassaanbinaslam.github.io/myblog/images/copied_from_nb/images/2022-07-07-sagemaker-script-mode.jpeg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-07-07T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://hassaanbinaslam.github.io/myblog/images/copied_from_nb/images/2022-07-07-sagemaker-script-mode.jpeg" />
<meta property="twitter:title" content="Deploy Scikit-learn Models to Amazon SageMaker with the SageMaker Python SDK using Script mode" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-07T00:00:00-05:00","datePublished":"2022-07-07T00:00:00-05:00","description":"The aim of this notebook is to demonstrate how to train and deploy a scikit-learn model in Amazon SageMaker using script mode.","headline":"Deploy Scikit-learn Models to Amazon SageMaker with the SageMaker Python SDK using Script mode","image":"https://hassaanbinaslam.github.io/myblog/images/copied_from_nb/images/2022-07-07-sagemaker-script-mode.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://hassaanbinaslam.github.io/myblog/aws/ml/sagemaker/2022/07/07/sagemaker-script-mode.html"},"url":"https://hassaanbinaslam.github.io/myblog/aws/ml/sagemaker/2022/07/07/sagemaker-script-mode.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/myblog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://hassaanbinaslam.github.io/myblog/feed.xml" title="Random Thoughts" /><!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TMJ59ZML0G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TMJ59ZML0G');
</script>


<link rel="shortcut icon" type="image/x-icon" href="/myblog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" /><script src="https://hypothes.is/embed.js" async></script>

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper">
<a class="site-title" rel="author" href="/myblog/">Random Thoughts</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/myblog/about/">About Me</a><a class="page-link" href="/myblog/search/">Search</a><a class="page-link" href="/myblog/categories/">Tags</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deploy Scikit-learn Models to Amazon SageMaker with the SageMaker Python SDK using Script mode</h1>
<p class="page-description">The aim of this notebook is to demonstrate how to train and deploy a scikit-learn model in Amazon SageMaker using script mode.</p>
<p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-07-07T00:00:00-05:00" itemprop="datePublished">
        Jul 7, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      79 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i> 
      
        <a class="category-tags-link" href="/myblog/categories/#aws">aws</a>
         
      
        <a class="category-tags-link" href="/myblog/categories/#ml">ml</a>
         
      
        <a class="category-tags-link" href="/myblog/categories/#sagemaker">sagemaker</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/hassaanbinaslam/myblog/tree/master/_notebooks/2022-07-07-sagemaker-script-mode.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/myblog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/hassaanbinaslam/myblog/master?filepath=_notebooks%2F2022-07-07-sagemaker-script-mode.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/myblog/assets/badges/binder.svg" alt="Open In Binder">
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/hassaanbinaslam/myblog/blob/master/_notebooks/2022-07-07-sagemaker-script-mode.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/myblog/assets/badges/colab.svg" alt="Open In Colab">
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Fhassaanbinaslam%2Fmyblog%2Fblob%2Fmaster%2F_notebooks%2F2022-07-07-sagemaker-script-mode.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/myblog/assets/badges/deepnote.svg" alt="Launch in Deepnote">
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#Introduction">Introduction </a></li>
<li class="toc-entry toc-h1"><a href="#Environment">Environment </a></li>
<li class="toc-entry toc-h1">
<a href="#Prepare-training-and-test-data">Prepare training and test data </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Download-and-preprocess-data">Download and preprocess data </a></li>
<li class="toc-entry toc-h2"><a href="#Prepare-and-store-train-and-test-sets-as-CSV-files">Prepare and store train and test sets as CSV files </a></li>
<li class="toc-entry toc-h2"><a href="#Create-SageMaker-session">Create SageMaker session </a></li>
<li class="toc-entry toc-h2"><a href="#Upload-data-to-Amazon-S3-bucket">Upload data to Amazon S3 bucket </a></li>
</ul>
</li>
<li class="toc-entry toc-h1">
<a href="#Prepare-SageMaker-local-environment">Prepare SageMaker local environment </a>
<ul>
<li class="toc-entry toc-h2"><a href="#How-SageMaker-managed-environment-works?">How SageMaker managed environment works? </a></li>
<li class="toc-entry toc-h2">
<a href="#Steps-to-prepare-Amazon-SageMaker-local-environment">Steps to prepare Amazon SageMaker local environment </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Instructions-for-SageMaker-notebook-instances">Instructions for SageMaker notebook instances </a></li>
<li class="toc-entry toc-h3"><a href="#Instructions-for-SageMaker-Studio-environment">Instructions for SageMaker Studio environment </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Create-SageMaker-local-session">Create SageMaker local session </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Prepare-SageMaker-training-script">Prepare SageMaker training script </a></li>
<li class="toc-entry toc-h1"><a href="#Prepare-SageMaker-SKLearn-estimator">Prepare SageMaker SKLearn estimator </a></li>
<li class="toc-entry toc-h1">
<a href="#Understanding-SKLearn-container-output-and-environment-varaibles">Understanding SKLearn container output and environment varaibles </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Inspecting-SageMaker-SKLearn-docker-image">Inspecting SageMaker SKLearn docker image </a></li>
<li class="toc-entry toc-h2"><a href="#Pass-hyperparameters-to-SKLearn-estimator">Pass hyperparameters to SKLearn estimator </a></li>
<li class="toc-entry toc-h2">
<a href="#SageMaker-SKLearn-container-environment-variables">SageMaker SKLearn container environment variables </a>
<ul>
<li class="toc-entry toc-h3"><a href="#SM_MODULE_DIR">SM_MODULE_DIR </a></li>
<li class="toc-entry toc-h3"><a href="#SM_MODEL_DIR">SM_MODEL_DIR </a></li>
<li class="toc-entry toc-h3"><a href="#SM_OUTPUT_DATA_DIR">SM_OUTPUT_DATA_DIR </a></li>
<li class="toc-entry toc-h3"><a href="#SM_CHANNELS">SM_CHANNELS </a></li>
<li class="toc-entry toc-h3"><a href="#SM-CHANNEL-%7Bchannel_name%7D">SM CHANNEL {channel_name} </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Pass-input-channel-to-SKLearn-estimator">Pass input channel to SKLearn estimator </a></li>
<li class="toc-entry toc-h1"><a href="#Summary-till-now">Summary till now </a></li>
<li class="toc-entry toc-h1"><a href="#Prepare-training-script-for-RandomForestClassifier">Prepare training script for RandomForestClassifier </a></li>
<li class="toc-entry toc-h1"><a href="#Passing-custom-libraries-and-dependencies-to-SKLean-container">Passing custom libraries and dependencies to SKLean container </a></li>
<li class="toc-entry toc-h1"><a href="#Serve-SKLearn-model-in-local-mode">Serve SKLearn model in local mode </a></li>
<li class="toc-entry toc-h1"><a href="#SKLean-model-server-input-and-output-processing">SKLean model server input and output processing </a></li>
<li class="toc-entry toc-h1"><a href="#SKLearn-model-training-and-serving-in-SageMaker-managed-environment">SKLearn model training and serving in SageMaker managed environment </a></li>
</ul>
<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-07-07-sagemaker-script-mode.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/myblog/images/copied_from_nb/images/2022-07-07-sagemaker-script-mode.jpeg" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Introduction">
<a class="anchor" href="#Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction<a class="anchor-link" href="#Introduction"> </a>
</h1>
<p>You may have trained a model with your favorite ML framework, and now you are asked to move your code to Amazon SageMaker. The good news is that SageMaker's fully managed training works well with many popular ML frameworks, including <code>scikit-learn</code>. In addition, SageMaker provides its prebuilt container for the scikit-learn framework, enabling us to seamlessly port our scripts to SageMaker and benefit from its training and deployment capabilities. SageMaker's scikit-learn Container is an open source library for making the scikit-learn framework run on the Amazon SageMaker platform. You can read more about sklearn container features from its GitHub page <a href="https://github.com/aws/sagemaker-scikit-learn-container">SageMaker Scikit-learn Container</a>.</p>
<p>Amazon SageMaker also provides open source Python SDK to train and deploy models on SageMaker. SageMaker SDK provides several high-level abstractions (classes), including:</p>
<ul>
<li>
<code>Session</code> Provides a collection of methods for working with SageMaker resources </li>
<li>
<code>Estimators</code> Encapsulate training on SageMaker</li>
<li>
<code>Predictors</code> Provide real-time inference and transformation using Python data types against a SageMaker endpoint</li>
</ul>
<p>You can read more on SageMaker Python SDK from its official site <a href="https://sagemaker.readthedocs.io/en/stable/overview.html">Amazon SageMaker Python SDK</a></p>
<p>This approach of using a custom training script with SageMaker's prebuilt container is commonly called as <strong>Script Mode</strong>. To train a scikit-learn model by using the SageMaker Python SDK involves three steps:</p>
<ol>
<li>
<strong>Prepare a training script</strong>. The training script is similar to any other scikit-learn training script that you might use outside of SageMaker</li>
<li>
<strong>Create an Estimator object from class <code>sagemaker.sklearn.SKLearn</code></strong>. Scikit-learn estimator class handles end-to-end training and deployment of custom scikit-learn code. We pass our training script to the SKLearn estimator, and it executes the script within a SageMaker Training Job. This training job is an Amazon-built Docker container that runs functions defined in the provided Python script. </li>
<li>
<strong>Call the Estimator's <code>fit</code> method on training data</strong>. Training is started by calling <code>fit()</code> on this Estimator. After training is complete, calling <code>deploy()</code> creates a hosted SageMaker endpoint and returns a <code>SKLearnPredictor</code> instance that can be used to perform inference against the hosted model. We will discuss the <code>SKLearn</code> Estimator in more detail later in this post.</li>
</ol>
<p>To read more about using scikit-learn with the SageMaker Python SDK, you may refer to the official documentation <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/sklearn/using_sklearn.html">using Scikit-learn with the SageMaker Python SDK</a>. The official documentation is valuable, and I would highly recommend checking it and keeping it as a reference.</p>
<p>In this post we will built a scikit-learn <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html">RandomForrestClassifier</a> on <a href="https://archive.ics.uci.edu/ml/datasets/iris">iris public dataset</a>. There is a similar example in SageMaker documentation. <a href="https://sagemaker-examples.readthedocs.io/en/latest/sagemaker-script-mode/sklearn/sklearn_byom_outputs.html">Train a SKLearn Model using Script Mode</a>. But it does not discuss many important aspects of a scikit-learn container and its environment. In this post, we will learn about them and cover all the details of training a scikit-learn model with script mode. I also noted that the example in the documentation uses <code>RandomForrestRegressor</code> on a classification problem which I believe is a mistake.</p>
<p>We have much to cover and learn, so let's start.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Environment">
<a class="anchor" href="#Environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Environment<a class="anchor-link" href="#Environment"> </a>
</h1>
<p>This notebook is prepared with AWS SageMaker notebook running on <code>ml.t3.medium</code> instance and "conda_python3" kernel.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>aws --version
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>aws-cli/1.22.97 Python/3.8.12 Linux/5.10.102-99.473.amzn2.x86_64 botocore/1.24.19
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>cat /etc/os-release
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>NAME="Amazon Linux"
VERSION="2"
ID="amzn"
ID_LIKE="centos rhel fedora"
VERSION_ID="2"
PRETTY_NAME="Amazon Linux 2"
ANSI_COLOR="0;33"
CPE_NAME="cpe:2.3:o:amazon:amazon_linux:2"
HOME_URL="https://amazonlinux.com/"
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>python3 --version
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Python 3.8.12
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>conda env list
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre># conda environments:
#
base                     /home/ec2-user/anaconda3
JupyterSystemEnv         /home/ec2-user/anaconda3/envs/JupyterSystemEnv
R                        /home/ec2-user/anaconda3/envs/R
amazonei_mxnet_p36       /home/ec2-user/anaconda3/envs/amazonei_mxnet_p36
amazonei_pytorch_latest_p37     /home/ec2-user/anaconda3/envs/amazonei_pytorch_latest_p37
amazonei_tensorflow2_p36     /home/ec2-user/anaconda3/envs/amazonei_tensorflow2_p36
mxnet_p37                /home/ec2-user/anaconda3/envs/mxnet_p37
python3               *  /home/ec2-user/anaconda3/envs/python3
pytorch_p38              /home/ec2-user/anaconda3/envs/pytorch_p38
tensorflow2_p38          /home/ec2-user/anaconda3/envs/tensorflow2_p38

</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Prepare-training-and-test-data">
<a class="anchor" href="#Prepare-training-and-test-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prepare training and test data<a class="anchor-link" href="#Prepare-training-and-test-data"> </a>
</h1>
<p>We will use <strong>Iris flower dataset</strong>. It includes three iris species (Iris setosa, Iris virginica, and Iris versicolor) with 50 samples each. Four features were measured for each sample: the length and the width of the sepals and petals, in centimeters. We can train a model to distinguish the species from each other based on the combination of these four features. You can read more about this dataset at <a href="https://en.wikipedia.org/wiki/Iris_flower_data_set">Iris flower data set</a>. The dataset has five columns representing.</p>
<ol>
<li>sepal length in cm</li>
<li>sepal width in cm</li>
<li>petal length in cm</li>
<li>petal width in cm</li>
<li>class: Iris Setosa, Iris Versicolour, Iris Virginica</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Download-and-preprocess-data">
<a class="anchor" href="#Download-and-preprocess-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Download and preprocess data<a class="anchor-link" href="#Download-and-preprocess-data"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># download dataset</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">"s3"</span><span class="p">)</span>
<span class="n">s3</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">"sagemaker-sample-files"</span><span class="p">,</span> <span class="s2">"datasets/tabular/iris/iris.data"</span><span class="p">,</span> <span class="s2">"iris.data"</span>
<span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">"iris.data"</span><span class="p">,</span>
    <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">"sepal_len"</span><span class="p">,</span> <span class="s2">"sepal_wid"</span><span class="p">,</span> <span class="s2">"petal_len"</span><span class="p">,</span> <span class="s2">"petal_wid"</span><span class="p">,</span> <span class="s2">"class"</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sepal_len</th>
      <th>sepal_wid</th>
      <th>petal_len</th>
      <th>petal_wid</th>
      <th>class</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5.1</td>
      <td>3.5</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>Iris-setosa</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4.9</td>
      <td>3.0</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>Iris-setosa</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4.7</td>
      <td>3.2</td>
      <td>1.3</td>
      <td>0.2</td>
      <td>Iris-setosa</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4.6</td>
      <td>3.1</td>
      <td>1.5</td>
      <td>0.2</td>
      <td>Iris-setosa</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5.0</td>
      <td>3.6</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>Iris-setosa</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Convert the three classes from strings to integers in {0,1,2}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">"class_cat"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"class"</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"category"</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>
<span class="n">categories_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"class"</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"category"</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">categories_map</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{0: 'Iris-setosa', 1: 'Iris-versicolor', 2: 'Iris-virginica'}
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sepal_len</th>
      <th>sepal_wid</th>
      <th>petal_len</th>
      <th>petal_wid</th>
      <th>class</th>
      <th>class_cat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5.1</td>
      <td>3.5</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>Iris-setosa</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4.9</td>
      <td>3.0</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>Iris-setosa</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4.7</td>
      <td>3.2</td>
      <td>1.3</td>
      <td>0.2</td>
      <td>Iris-setosa</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4.6</td>
      <td>3.1</td>
      <td>1.5</td>
      <td>0.2</td>
      <td>Iris-setosa</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5.0</td>
      <td>3.6</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>Iris-setosa</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Prepare-and-store-train-and-test-sets-as-CSV-files">
<a class="anchor" href="#Prepare-and-store-train-and-test-sets-as-CSV-files" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prepare and store train and test sets as CSV files<a class="anchor-link" href="#Prepare-and-store-train-and-test-sets-as-CSV-files"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># split the data into train and test set</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"train.shape: </span><span class="si">{</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"test.shape: </span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>train.shape: (120, 6)
test.shape: (30, 6)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We have our dataset ready. Let's define a local directory <code>local_path</code> to keep all the files and artifacts related to this post. I will refer to this directory as 'workspace'.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># `local_path` will be the root directory for this post.</span>
<span class="n">local_path</span> <span class="o">=</span> <span class="s2">"./datasets/2022-07-07-sagemaker-script-mode"</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We have train and test sets ready. Let's create two more directories in our workspace and store our data in them.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># local paths</span>
<span class="n">local_train_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">+</span> <span class="s2">"/train"</span>
<span class="n">local_test_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">+</span> <span class="s2">"/test"</span>

<span class="c1"># create local directories</span>
<span class="n">Path</span><span class="p">(</span><span class="n">local_train_path</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">Path</span><span class="p">(</span><span class="n">local_test_path</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"local_train_path: "</span><span class="p">,</span> <span class="n">local_train_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"local_test_path: "</span><span class="p">,</span> <span class="n">local_test_path</span><span class="p">)</span>

<span class="c1"># local file names</span>
<span class="n">local_train_file</span> <span class="o">=</span> <span class="n">local_train_path</span> <span class="o">+</span> <span class="s2">"/train.csv"</span>
<span class="n">local_test_file</span> <span class="o">=</span> <span class="n">local_test_path</span> <span class="o">+</span> <span class="s2">"/test.csv"</span>

<span class="c1"># write train and test CSV files</span>
<span class="n">train</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">local_train_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">local_test_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"local_train_file: "</span><span class="p">,</span> <span class="n">local_train_file</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"local_test_file: "</span><span class="p">,</span> <span class="n">local_test_file</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>local_train_path:  ./datasets/2022-07-07-sagemaker-script-mode/train
local_test_path:  ./datasets/2022-07-07-sagemaker-script-mode/test
local_train_file:  ./datasets/2022-07-07-sagemaker-script-mode/train/train.csv
local_test_file:  ./datasets/2022-07-07-sagemaker-script-mode/test/test.csv
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-SageMaker-session">
<a class="anchor" href="#Create-SageMaker-session" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create SageMaker session<a class="anchor-link" href="#Create-SageMaker-session"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sagemaker</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">role</span> <span class="o">=</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">get_execution_role</span><span class="p">()</span>
<span class="n">bucket</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">default_bucket</span><span class="p">()</span>
<span class="n">region</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">boto_region_name</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"sagemaker.__version__: "</span><span class="p">,</span> <span class="n">sagemaker</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Session: "</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Role: "</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Bucket: "</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Region: "</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sagemaker.__version__:  2.86.2
Session:  &lt;sagemaker.session.Session object at 0x7f80ad720460&gt;
Role:  arn:aws:iam::801598032724:role/service-role/AmazonSageMakerServiceCatalogProductsUseRole
Bucket:  sagemaker-us-east-1-801598032724
Region:  us-east-1
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>What we have done here is</p>
<ul>
<li>imported the SageMaker Python SDK into our runtime</li>
<li>get a session to work with SageMaker API and other AWS services</li>
<li>get the execution role associated with the user profile. It is the same profile that is available to the user to work from console UI and has <code>AmazonSageMakerFullAccess</code> policy attached to it.</li>
<li>create or get a default bucket to use and return its name. Default bucket name has the format <code>sagemaker-{region}-{account_id}</code>. If it doesn't exist then our session will automatically create it. You may also use any other bucket in its place given that you have enough permission for reading and writing.</li>
<li>get the region name attached to our session</li>
</ul>
<p>Next, we will use this session to upload data to our default bucket.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Upload-data-to-Amazon-S3-bucket">
<a class="anchor" href="#Upload-data-to-Amazon-S3-bucket" aria-hidden="true"><span class="octicon octicon-link"></span></a>Upload data to Amazon S3 bucket<a class="anchor-link" href="#Upload-data-to-Amazon-S3-bucket"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># You may choose any other prefix for your bucket.</span>
<span class="c1"># All the data related to this post will be under this prefix.</span>
<span class="n">bucket_prefix</span> <span class="o">=</span> <span class="s2">"2022-07-07-sagemaker-script-mode"</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now upload the data. In the output, we will get the complete path (S3 URI) for our uploaded data.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">s3_train_uri</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">upload_data</span><span class="p">(</span><span class="n">local_train_file</span><span class="p">,</span> <span class="n">key_prefix</span><span class="o">=</span><span class="n">bucket_prefix</span> <span class="o">+</span> <span class="s2">"/data"</span><span class="p">)</span>
<span class="n">s3_test_uri</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">upload_data</span><span class="p">(</span><span class="n">local_test_file</span><span class="p">,</span> <span class="n">key_prefix</span><span class="o">=</span><span class="n">bucket_prefix</span> <span class="o">+</span> <span class="s2">"/data"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"s3_train_uri: "</span><span class="p">,</span> <span class="n">s3_train_uri</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"s3_test_uri: "</span><span class="p">,</span> <span class="n">s3_test_uri</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>s3_train_uri:  s3://sagemaker-us-east-1-801598032724/2022-07-07-sagemaker-script-mode/data/train.csv
s3_test_uri:  s3://sagemaker-us-east-1-801598032724/2022-07-07-sagemaker-script-mode/data/test.csv
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At this point, our data preparation step is complete. Train and test CSV files are available on the local system and in our default Amazon S3 bucket.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Prepare-SageMaker-local-environment">
<a class="anchor" href="#Prepare-SageMaker-local-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prepare SageMaker local environment<a class="anchor-link" href="#Prepare-SageMaker-local-environment"> </a>
</h1>
<p>The Amazon SageMaker training environment is managed, but SageMaker Python SDK also supports <strong>local mode</strong>, allowing you to train and deploy models to your local environment. This is a great way to test training scripts before running them in SageMaker's managed training or hosting environment.</p>
<h2 id="How-SageMaker-managed-environment-works?">
<a class="anchor" href="#How-SageMaker-managed-environment-works?" aria-hidden="true"><span class="octicon octicon-link"></span></a>How SageMaker managed environment works?<a class="anchor-link" href="#How-SageMaker-managed-environment-works?"> </a>
</h2>
<p>When you send a request to SageMaker API (<code>fit</code> or <code>deploy</code> call)</p>
<ul>
<li>it spins up new instances with the provided specification</li>
<li>loads the algorithm container</li>
<li>pulls the data from S3</li>
<li>runs the training code</li>
<li>store the results and trained model artifacts to S3</li>
<li>terminates the new instances</li>
</ul>
<p>All this happens behind the scenes with a single line of code and is a huge advantage. Spinning up new hardware every time can be good for repeatability and security, but it can add some friction while testing and debugging our code. We can test our code on a small dataset in our local environment with SageMaker local mode and then switch seamlessly to SageMaker managed environment by changing a single line of code.</p>
<h2 id="Steps-to-prepare-Amazon-SageMaker-local-environment">
<a class="anchor" href="#Steps-to-prepare-Amazon-SageMaker-local-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Steps to prepare Amazon SageMaker local environment<a class="anchor-link" href="#Steps-to-prepare-Amazon-SageMaker-local-environment"> </a>
</h2>
<p>Install the following pre-requisites if you want to set up Amazon SageMaker on your local system.</p>
<ol>
<li>Install required Python packages:
<pre><code> pip install boto3 sagemaker pandas scikit-learn
 pip install 'sagemaker[local]'</code></pre>
</li>
<li>Docker Desktop installed and running on your computer:
<pre><code> docker ps</code></pre>
</li>
<li>You should have AWS credentials configured on your local machine to be able to pull the docker image from ECR.</li>
</ol>
<h3 id="Instructions-for-SageMaker-notebook-instances">
<a class="anchor" href="#Instructions-for-SageMaker-notebook-instances" aria-hidden="true"><span class="octicon octicon-link"></span></a>Instructions for SageMaker notebook instances<a class="anchor-link" href="#Instructions-for-SageMaker-notebook-instances"> </a>
</h3>
<p>You can also set up SageMaker's local environment in SageMaker notebook instances. Required Python packages and Docker service is already there. You only need to upgrade the <code>sagemaker[local]</code> Python package.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># this is required for SageMaker notebook instances</span>
<span class="o">!</span>pip install <span class="s1">'sagemaker[local]'</span> --upgrade
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Looking in indexes: https://pypi.org/simple, https://pip.repos.neuron.amazonaws.com
Requirement already satisfied: sagemaker[local] in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (2.86.2)
Collecting sagemaker[local]
  Downloading sagemaker-2.99.0.tar.gz (542 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">542.7/542.7 KB</span> <span class="ansi-red-fg">10.6 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:01
  Preparing metadata (setup.py) ... done
Requirement already satisfied: attrs&lt;22,&gt;=20.3.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (20.3.0)
Requirement already satisfied: boto3&lt;2.0,&gt;=1.20.21 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (1.21.42)
Requirement already satisfied: google-pasta in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (0.2.0)
Requirement already satisfied: numpy&lt;2.0,&gt;=1.9.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (1.20.3)
Requirement already satisfied: protobuf&lt;4.0,&gt;=3.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (3.19.1)
Requirement already satisfied: protobuf3-to-dict&lt;1.0,&gt;=0.1.5 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (0.1.5)
Requirement already satisfied: smdebug_rulesconfig==1.0.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (1.0.1)
Requirement already satisfied: importlib-metadata&lt;5.0,&gt;=1.4.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (4.8.2)
Requirement already satisfied: packaging&gt;=20.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (21.3)
Requirement already satisfied: pandas in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (1.3.4)
Requirement already satisfied: pathos in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (0.2.8)
Requirement already satisfied: urllib3==1.26.8 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (1.26.8)
Requirement already satisfied: docker-compose==1.29.2 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (1.29.2)
Requirement already satisfied: docker~=5.0.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (5.0.3)
Requirement already satisfied: PyYAML==5.4.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from sagemaker[local]) (5.4.1)
Requirement already satisfied: texttable&lt;2,&gt;=0.9.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from docker-compose==1.29.2-&gt;sagemaker[local]) (1.6.4)
Requirement already satisfied: websocket-client&lt;1,&gt;=0.32.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from docker-compose==1.29.2-&gt;sagemaker[local]) (0.59.0)
Requirement already satisfied: docopt&lt;1,&gt;=0.6.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from docker-compose==1.29.2-&gt;sagemaker[local]) (0.6.2)
Requirement already satisfied: jsonschema&lt;4,&gt;=2.5.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from docker-compose==1.29.2-&gt;sagemaker[local]) (3.2.0)
Requirement already satisfied: dockerpty&lt;1,&gt;=0.4.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from docker-compose==1.29.2-&gt;sagemaker[local]) (0.4.1)
Requirement already satisfied: distro&lt;2,&gt;=1.5.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from docker-compose==1.29.2-&gt;sagemaker[local]) (1.7.0)
Requirement already satisfied: python-dotenv&lt;1,&gt;=0.13.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from docker-compose==1.29.2-&gt;sagemaker[local]) (0.20.0)
Requirement already satisfied: requests&lt;3,&gt;=2.20.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from docker-compose==1.29.2-&gt;sagemaker[local]) (2.26.0)
Collecting botocore&lt;1.25.0,&gt;=1.24.42
  Downloading botocore-1.24.46-py3-none-any.whl (8.7 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">8.7/8.7 MB</span> <span class="ansi-red-fg">34.3 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>:00:0100:01
Requirement already satisfied: s3transfer&lt;0.6.0,&gt;=0.5.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from boto3&lt;2.0,&gt;=1.20.21-&gt;sagemaker[local]) (0.5.2)
Requirement already satisfied: jmespath&lt;2.0.0,&gt;=0.7.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from boto3&lt;2.0,&gt;=1.20.21-&gt;sagemaker[local]) (0.10.0)
Requirement already satisfied: zipp&gt;=0.5 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from importlib-metadata&lt;5.0,&gt;=1.4.0-&gt;sagemaker[local]) (3.6.0)
Requirement already satisfied: pyparsing!=3.0.5,&gt;=2.0.2 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from packaging&gt;=20.0-&gt;sagemaker[local]) (3.0.6)
Requirement already satisfied: six in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from protobuf3-to-dict&lt;1.0,&gt;=0.1.5-&gt;sagemaker[local]) (1.16.0)
Requirement already satisfied: python-dateutil&gt;=2.7.3 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from pandas-&gt;sagemaker[local]) (2.8.2)
Requirement already satisfied: pytz&gt;=2017.3 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from pandas-&gt;sagemaker[local]) (2021.3)
Requirement already satisfied: multiprocess&gt;=0.70.12 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from pathos-&gt;sagemaker[local]) (0.70.12.2)
Requirement already satisfied: pox&gt;=0.3.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from pathos-&gt;sagemaker[local]) (0.3.0)
Requirement already satisfied: dill&gt;=0.3.4 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from pathos-&gt;sagemaker[local]) (0.3.4)
Requirement already satisfied: ppft&gt;=1.6.6.4 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from pathos-&gt;sagemaker[local]) (1.6.6.4)
Requirement already satisfied: paramiko&gt;=2.4.2 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from docker~=5.0.0-&gt;sagemaker[local]) (2.10.3)
Requirement already satisfied: pyrsistent&gt;=0.14.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from jsonschema&lt;4,&gt;=2.5.1-&gt;docker-compose==1.29.2-&gt;sagemaker[local]) (0.18.0)
Requirement already satisfied: setuptools in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from jsonschema&lt;4,&gt;=2.5.1-&gt;docker-compose==1.29.2-&gt;sagemaker[local]) (59.4.0)
Requirement already satisfied: charset-normalizer~=2.0.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from requests&lt;3,&gt;=2.20.0-&gt;docker-compose==1.29.2-&gt;sagemaker[local]) (2.0.8)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from requests&lt;3,&gt;=2.20.0-&gt;docker-compose==1.29.2-&gt;sagemaker[local]) (3.1)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from requests&lt;3,&gt;=2.20.0-&gt;docker-compose==1.29.2-&gt;sagemaker[local]) (2021.10.8)
Requirement already satisfied: pynacl&gt;=1.0.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from paramiko&gt;=2.4.2-&gt;docker~=5.0.0-&gt;sagemaker[local]) (1.5.0)
Requirement already satisfied: cryptography&gt;=2.5 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from paramiko&gt;=2.4.2-&gt;docker~=5.0.0-&gt;sagemaker[local]) (36.0.0)
Requirement already satisfied: bcrypt&gt;=3.1.3 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from paramiko&gt;=2.4.2-&gt;docker~=5.0.0-&gt;sagemaker[local]) (3.2.0)
Requirement already satisfied: cffi&gt;=1.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from bcrypt&gt;=3.1.3-&gt;paramiko&gt;=2.4.2-&gt;docker~=5.0.0-&gt;sagemaker[local]) (1.15.0)
Requirement already satisfied: pycparser in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from cffi&gt;=1.1-&gt;bcrypt&gt;=3.1.3-&gt;paramiko&gt;=2.4.2-&gt;docker~=5.0.0-&gt;sagemaker[local]) (2.21)
Building wheels for collected packages: sagemaker
  Building wheel for sagemaker (setup.py) ... done
  Created wheel for sagemaker: filename=sagemaker-2.99.0-py2.py3-none-any.whl size=756462 sha256=309b5159cfb7f5c739c6159b8bf309bfa7ce28d2ca402296e824f3e84bc837c1
  Stored in directory: /home/ec2-user/.cache/pip/wheels/fc/df/14/14b7871f4cf108cfe8891338510d97e28cfe2da00f37114fcf
Successfully built sagemaker
Installing collected packages: botocore, sagemaker
  Attempting uninstall: botocore
    Found existing installation: botocore 1.24.19
    Uninstalling botocore-1.24.19:
      Successfully uninstalled botocore-1.24.19
  Attempting uninstall: sagemaker
    Found existing installation: sagemaker 2.86.2
    Uninstalling sagemaker-2.86.2:
      Successfully uninstalled sagemaker-2.86.2
<span class="ansi-red-fg">ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
awscli 1.22.97 requires botocore==1.24.42, but you have botocore 1.24.46 which is incompatible.
aiobotocore 2.0.1 requires botocore&lt;1.22.9,&gt;=1.22.8, but you have botocore 1.24.46 which is incompatible.</span><span class="ansi-red-fg">
</span>Successfully installed botocore-1.24.46 sagemaker-2.99.0
<span class="ansi-yellow-fg">WARNING: You are using pip version 22.0.4; however, version 22.1.2 is available.
You should consider upgrading via the '/home/ec2-user/anaconda3/envs/python3/bin/python -m pip install --upgrade pip' command.</span><span class="ansi-yellow-fg">
</span></pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Instructions-for-SageMaker-Studio-environment">
<a class="anchor" href="#Instructions-for-SageMaker-Studio-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Instructions for SageMaker Studio environment<a class="anchor-link" href="#Instructions-for-SageMaker-Studio-environment"> </a>
</h3>
<p>Note that SageMaker <code>local</code> mode will not work in SageMaker Studio environment as it does not have docker service installed on the provided instances.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-SageMaker-local-session">
<a class="anchor" href="#Create-SageMaker-local-session" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create SageMaker local session<a class="anchor-link" href="#Create-SageMaker-local-session"> </a>
</h2>
<p>SageMaker local session is required for working in a local environment. Let's create it.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sagemaker.local</span> <span class="kn">import</span> <span class="n">LocalSession</span>

<span class="n">session_local</span> <span class="o">=</span> <span class="n">LocalSession</span><span class="p">()</span>
<span class="n">session_local</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;sagemaker.local.local_session.LocalSession at 0x7f80ac223910&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># configure local session</span>
<span class="n">session_local</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"local"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"local_code"</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Prepare-SageMaker-training-script">
<a class="anchor" href="#Prepare-SageMaker-training-script" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prepare SageMaker training script<a class="anchor-link" href="#Prepare-SageMaker-training-script"> </a>
</h1>
<p>We will call our training script <code>train_and_serve.py</code> and place it in our workspace under the <code>/src</code> folder. Then, we will start with a simple <code>Hello World</code> message code. After that, we will update and complete our training script as we learn more about the SageMaker <code>scikit-learn</code> container environment.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">script_file_name</span> <span class="o">=</span> <span class="s2">"train_and_serve.py"</span>
<span class="n">script_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">+</span> <span class="s2">"/src"</span>
<span class="n">script_file</span> <span class="o">=</span> <span class="n">script_path</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="n">script_file_name</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"script_file_name: "</span><span class="p">,</span> <span class="n">script_file_name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"script_path: "</span><span class="p">,</span> <span class="n">script_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"script_file: "</span><span class="p">,</span> <span class="n">script_file</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>script_file_name:  train_and_serve.py
script_path:  ./datasets/2022-07-07-sagemaker-script-mode/src
script_file:  ./datasets/2022-07-07-sagemaker-script-mode/src/train_and_serve.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># make sure that the directory exists</span>
<span class="n">Path</span><span class="p">(</span><span class="n">script_path</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now the training script.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> $script_file

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"*** Hello from the SageMaker script mode***"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting ./datasets/2022-07-07-sagemaker-script-mode/src/train_and_serve.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Prepare-SageMaker-SKLearn-estimator">
<a class="anchor" href="#Prepare-SageMaker-SKLearn-estimator" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prepare SageMaker SKLearn estimator<a class="anchor-link" href="#Prepare-SageMaker-SKLearn-estimator"> </a>
</h1>
<p>To create SKLearn Estimator object we need to pass it following items</p>
<ul>
<li>
<strong><code>entry_point (str)</code></strong> Path (absolute or relative) to the Python source file, which should be executed as the entry point to training</li>
<li>
<strong><code>framework_version (str)</code></strong> Scikit-learn version you want to use for executing your model training code</li>
<li>
<strong><code>role (str)</code></strong> An AWS IAM role (either name or full ARN)</li>
<li>
<strong><code>instance_type (str)</code></strong> Type of instance to use for training. For local mode use string <strong><code>local</code></strong>
</li>
<li>
<strong><code>instance_count (int)</code></strong> Number of instances to use for training. Since we will train in the local environment and have a single instance, we will use '1' here</li>
</ul>
<p>You can read more about the SKLearn Estimator class from the official documentation <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/sklearn/sagemaker.sklearn.html">Scikit Learn Estimator</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's find the SKLearn framework version.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sklearn</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1.0.1
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that version number <code>1.0.1</code> has to be provided to the SKLearn estimator class as <strong><code>1.0-1</code></strong>. Otherwise, you will get the following error message.</p>

<pre><code>ValueError: Unsupported sklearn version: 1.0.1. You may need to upgrade your SDK version (pip install -U sagemaker) for newer sklearn versions. Supported sklearn version(s): 0.20.0, 0.23-1, 1.0-1.</code></pre>
<p>Now let us create the SageMaker SKLearn estimator object and pass our training script to it.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sagemaker.sklearn</span> <span class="kn">import</span> <span class="n">SKLearn</span>

<span class="n">sk_estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="n">script_file</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s2">"local"</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"1.0-1"</span>
<span class="p">)</span>

<span class="n">sk_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>WARNING! Using --password via the CLI is insecure. Use --password-stdin.
WARNING! Your password will be stored unencrypted in /home/ec2-user/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating fvm7gkf0bq-algo-1-ju7k8 ... 
Creating fvm7gkf0bq-algo-1-ju7k8 ... done
Attaching to fvm7gkf0bq-algo-1-ju7k8
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 2022-07-17 15:23:43,041 sagemaker-containers INFO     Imported framework sagemaker_sklearn_container.training
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 2022-07-17 15:23:43,045 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 2022-07-17 15:23:43,054 sagemaker_sklearn_container.training INFO     Invoking user training script.
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 2022-07-17 15:23:43,272 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 2022-07-17 15:23:43,284 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 2022-07-17 15:23:43,297 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 2022-07-17 15:23:43,306 sagemaker-training-toolkit INFO     Invoking user script
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> Training Env:
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> {
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "additional_framework_parameters": {},
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "channel_input_dirs": {},
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "current_host": "algo-1-ju7k8",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "framework_module": "sagemaker_sklearn_container.training:main",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "hosts": [
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>         "algo-1-ju7k8"
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     ],
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "hyperparameters": {},
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "input_config_dir": "/opt/ml/input/config",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "input_data_config": {},
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "input_dir": "/opt/ml/input",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "is_master": true,
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "job_name": "sagemaker-scikit-learn-2022-07-17-15-22-17-814",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "log_level": 20,
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "master_hostname": "algo-1-ju7k8",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "model_dir": "/opt/ml/model",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "module_dir": "s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-22-17-814/source/sourcedir.tar.gz",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "module_name": "train_and_serve",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "network_interface_name": "eth0",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "num_cpus": 2,
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "num_gpus": 0,
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "output_data_dir": "/opt/ml/output/data",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "output_dir": "/opt/ml/output",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "output_intermediate_dir": "/opt/ml/output/intermediate",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "resource_config": {
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>         "current_host": "algo-1-ju7k8",
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>         "hosts": [
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>             "algo-1-ju7k8"
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>         ]
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     },
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span>     "user_entry_point": "train_and_serve.py"
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> }
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> Environment variables:
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_HOSTS=["algo-1-ju7k8"]
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_NETWORK_INTERFACE_NAME=eth0
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_HPS={}
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_USER_ENTRY_POINT=train_and_serve.py
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_FRAMEWORK_PARAMS={}
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_RESOURCE_CONFIG={"current_host":"algo-1-ju7k8","hosts":["algo-1-ju7k8"]}
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_INPUT_DATA_CONFIG={}
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_OUTPUT_DATA_DIR=/opt/ml/output/data
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_CHANNELS=[]
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_CURRENT_HOST=algo-1-ju7k8
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_MODULE_NAME=train_and_serve
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_LOG_LEVEL=20
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_FRAMEWORK_MODULE=sagemaker_sklearn_container.training:main
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_INPUT_DIR=/opt/ml/input
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_INPUT_CONFIG_DIR=/opt/ml/input/config
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_OUTPUT_DIR=/opt/ml/output
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_NUM_CPUS=2
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_NUM_GPUS=0
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_MODEL_DIR=/opt/ml/model
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-22-17-814/source/sourcedir.tar.gz
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{},"current_host":"algo-1-ju7k8","framework_module":"sagemaker_sklearn_container.training:main","hosts":["algo-1-ju7k8"],"hyperparameters":{},"input_config_dir":"/opt/ml/input/config","input_data_config":{},"input_dir":"/opt/ml/input","is_master":true,"job_name":"sagemaker-scikit-learn-2022-07-17-15-22-17-814","log_level":20,"master_hostname":"algo-1-ju7k8","model_dir":"/opt/ml/model","module_dir":"s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-22-17-814/source/sourcedir.tar.gz","module_name":"train_and_serve","network_interface_name":"eth0","num_cpus":2,"num_gpus":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_host":"algo-1-ju7k8","hosts":["algo-1-ju7k8"]},"user_entry_point":"train_and_serve.py"}
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_USER_ARGS=[]
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> PYTHONPATH=/opt/ml/code:/miniconda3/bin:/miniconda3/lib/python38.zip:/miniconda3/lib/python3.8:/miniconda3/lib/python3.8/lib-dynload:/miniconda3/lib/python3.8/site-packages
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> Invoking script with the following command:
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> /miniconda3/bin/python train_and_serve.py
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> *** Hello from the SageMaker script mode***
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 |</span> 2022-07-17 15:23:43,332 sagemaker-containers INFO     Reporting training SUCCESS
<span class="ansi-cyan-fg">fvm7gkf0bq-algo-1-ju7k8 exited with code 0
</span>Aborting on container exit...
===== Job Complete =====
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># The estimator will pick a local session when we use instance_type='local'</span>
<span class="n">sk_estimator</span><span class="o">.</span><span class="n">sagemaker_session</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;sagemaker.local.local_session.LocalSession at 0x7f80ac53da90&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When you first run the SKLearn estimator, executing it may take some time as it has to download the scikit-learn container to the local docker environment. You will get the container logs in the output when the container completes the execution. The logs show that the container has successfully run the training script, and the <code>hello</code> message is also printed. But there is a lot more information available in the logs. We will discuss it in the coming section.</p>
<p><img src="/myblog/images/copied_from_nb/images/2022-07-07-sagemaker-script-mode/sklearn-output-1.png" alt="sklearn-output-1"></p>
<h1 id="Understanding-SKLearn-container-output-and-environment-varaibles">
<a class="anchor" href="#Understanding-SKLearn-container-output-and-environment-varaibles" aria-hidden="true"><span class="octicon octicon-link"></span></a>Understanding SKLearn container output and environment varaibles<a class="anchor-link" href="#Understanding-SKLearn-container-output-and-environment-varaibles"> </a>
</h1>
<p>From the SKLearn estimator output, we can see that our <code>train_and_serve.py</code> script is executed by the container with the following command.</p>

<pre><code>/miniconda3/bin/python train_and_serve.py</code></pre>
<h2 id="Inspecting-SageMaker-SKLearn-docker-image">
<a class="anchor" href="#Inspecting-SageMaker-SKLearn-docker-image" aria-hidden="true"><span class="octicon octicon-link"></span></a>Inspecting SageMaker SKLearn docker image<a class="anchor-link" href="#Inspecting-SageMaker-SKLearn-docker-image"> </a>
</h2>
<p>Since the container was executed in the local environment, we can also inspect the SageMaker SKLearn local image.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>docker images
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>REPOSITORY                                                            TAG             IMAGE ID       CREATED       SIZE
683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn   1.0-1-cpu-py3   8a6ea8272ad0   10 days ago   3.7GB
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's also inspect the docker image. Notice multiple container environment variables and their default values in the output.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>docker inspect 8a6ea8272ad0
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[
    {
        "Id": "sha256:8a6ea8272ad003ec816569b0f879b16c770116584301161565f065aadb99436c",
        "RepoTags": [
            "683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:1.0-1-cpu-py3"
        ],
        "RepoDigests": [
            "683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn@sha256:fc8c3a617ff0e436c25f3b64d03e1f485f1d159478c26757f3d1d267fc849445"
        ],
        "Parent": "",
        "Comment": "",
        "Created": "2022-07-06T18:55:02.854297671Z",
        "Container": "11b9a5fec2d61294aee63e549100ed18ceb7aa0de6a4ff198da2f556dfe3ec2f",
        "ContainerConfig": {
            "Hostname": "11b9a5fec2d6",
            "Domainname": "",
            "User": "",
            "AttachStdin": false,
            "AttachStdout": false,
            "AttachStderr": false,
            "ExposedPorts": {
                "8080/tcp": {}
            },
            "Tty": false,
            "OpenStdin": false,
            "StdinOnce": false,
            "Env": [
                "PATH=/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
                "PYTHONDONTWRITEBYTECODE=1",
                "PYTHONUNBUFFERED=1",
                "PYTHONIOENCODING=UTF-8",
                "LANG=C.UTF-8",
                "LC_ALL=C.UTF-8",
                "SAGEMAKER_SKLEARN_VERSION=1.0-1",
                "SAGEMAKER_TRAINING_MODULE=sagemaker_sklearn_container.training:main",
                "SAGEMAKER_SERVING_MODULE=sagemaker_sklearn_container.serving:main",
                "SKLEARN_MMS_CONFIG=/home/model-server/config.properties",
                "SM_INPUT=/opt/ml/input",
                "SM_INPUT_TRAINING_CONFIG_FILE=/opt/ml/input/config/hyperparameters.json",
                "SM_INPUT_DATA_CONFIG_FILE=/opt/ml/input/config/inputdataconfig.json",
                "SM_CHECKPOINT_CONFIG_FILE=/opt/ml/input/config/checkpointconfig.json",
                "SM_MODEL_DIR=/opt/ml/model",
                "TEMP=/home/model-server/tmp"
            ],
            "Cmd": [
                "/bin/sh",
                "-c",
                "#(nop) ",
                "LABEL transform_id=9be8b540-703b-4ecd-a127-c37333a0dcec_sagemaker-scikit-learn-1_0"
            ],
            "Image": "sha256:58b15b990d550868caed6f885423deee97a6c7f525c228a043096bf28e775d18",
            "Volumes": null,
            "WorkingDir": "",
            "Entrypoint": null,
            "OnBuild": null,
            "Labels": {
                "TRANSFORM_TYPE": "Aggregate-1.0",
                "VERSION_SET_NAME": "SMFrameworksSKLearn/release-cdk",
                "VERSION_SET_REVISION": "6086988568",
                "com.amazonaws.sagemaker.capabilities.accept-bind-to-port": "true",
                "com.amazonaws.sagemaker.capabilities.multi-models": "true",
                "transform_id": "9be8b540-703b-4ecd-a127-c37333a0dcec_sagemaker-scikit-learn-1_0"
            }
        },
        "DockerVersion": "20.10.15",
        "Author": "",
        "Config": {
            "Hostname": "",
            "Domainname": "",
            "User": "",
            "AttachStdin": false,
            "AttachStdout": false,
            "AttachStderr": false,
            "ExposedPorts": {
                "8080/tcp": {}
            },
            "Tty": false,
            "OpenStdin": false,
            "StdinOnce": false,
            "Env": [
                "PATH=/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
                "PYTHONDONTWRITEBYTECODE=1",
                "PYTHONUNBUFFERED=1",
                "PYTHONIOENCODING=UTF-8",
                "LANG=C.UTF-8",
                "LC_ALL=C.UTF-8",
                "SAGEMAKER_SKLEARN_VERSION=1.0-1",
                "SAGEMAKER_TRAINING_MODULE=sagemaker_sklearn_container.training:main",
                "SAGEMAKER_SERVING_MODULE=sagemaker_sklearn_container.serving:main",
                "SKLEARN_MMS_CONFIG=/home/model-server/config.properties",
                "SM_INPUT=/opt/ml/input",
                "SM_INPUT_TRAINING_CONFIG_FILE=/opt/ml/input/config/hyperparameters.json",
                "SM_INPUT_DATA_CONFIG_FILE=/opt/ml/input/config/inputdataconfig.json",
                "SM_CHECKPOINT_CONFIG_FILE=/opt/ml/input/config/checkpointconfig.json",
                "SM_MODEL_DIR=/opt/ml/model",
                "TEMP=/home/model-server/tmp"
            ],
            "Cmd": [
                "bash"
            ],
            "Image": "sha256:58b15b990d550868caed6f885423deee97a6c7f525c228a043096bf28e775d18",
            "Volumes": null,
            "WorkingDir": "",
            "Entrypoint": null,
            "OnBuild": null,
            "Labels": {
                "TRANSFORM_TYPE": "Aggregate-1.0",
                "VERSION_SET_NAME": "SMFrameworksSKLearn/release-cdk",
                "VERSION_SET_REVISION": "6086988568",
                "com.amazonaws.sagemaker.capabilities.accept-bind-to-port": "true",
                "com.amazonaws.sagemaker.capabilities.multi-models": "true",
                "transform_id": "9be8b540-703b-4ecd-a127-c37333a0dcec_sagemaker-scikit-learn-1_0"
            }
        },
        "Architecture": "amd64",
        "Os": "linux",
        "Size": 3699696670,
        "VirtualSize": 3699696670,
        "GraphDriver": {
            "Data": {
                "LowerDir": "/var/lib/docker/overlay2/01a97258168fa360e9f6aa63ac0c6b2417c0ea0ebe888123edad87eb4a646765/diff:/var/lib/docker/overlay2/3b85b71e8fe52c7a27ae71ed492ff72c7e430cccdeea17046e2a361e8d7fd960/diff:/var/lib/docker/overlay2/7de8e16dd696c868ffd028a3ba1f1a80ef04237b9323229e578bc5e3aa6a29d7/diff:/var/lib/docker/overlay2/5eeb27014ab7ac7a894efdbb166d8a87fb9d4b8b739eccd82546ad6a2b53aa70/diff:/var/lib/docker/overlay2/bbd9a81a7aa5bf4c79e81ecf47670a3f8c098eee9c6682f36f88ec52db8e1946/diff:/var/lib/docker/overlay2/eb0e7f3a5bd45c1d611e4c37ba641d1e978043954312da5908fd4003c41c7e7d/diff:/var/lib/docker/overlay2/3daaedc78711e353befc51544a944ad35954327325d056094f445502bf65ce53/diff:/var/lib/docker/overlay2/9dd41e3edfb9d8f852732a968a7b179ca811e0f9d55614a0b193de753fc6aca0/diff:/var/lib/docker/overlay2/ede189a574c79eebc565041a44ebf8b586247a36a99fe3ff9588b8c940783498/diff:/var/lib/docker/overlay2/6b1d78a9c074a42d78650406b90b7b4f51eb31660a7b1e2dcc6d73cc43d29b6b/diff:/var/lib/docker/overlay2/3e0420f6740f876c9355d526cbdedd9ebde5be94ddf0d93d7dadd4f34cae351b/diff:/var/lib/docker/overlay2/de1a2da7ee1b5d9a1b4e5c3dd1adff213185dde7e1212db96c0435e512f50701/diff:/var/lib/docker/overlay2/bebca69aef394f0553634413c7875eb58228c7e6359a305a7501705e75c2b58b/diff:/var/lib/docker/overlay2/8a410db2a038a175ee6ddfb005383f8776c80b1b1901f5d2feedfc8d837ffa40/diff:/var/lib/docker/overlay2/6f6686a8cb3ccf47b214854717cbe33ba777e0985200e3d7b7f761f99231b274/diff:/var/lib/docker/overlay2/ad8b24fa9173d28a83284e4f31d830f1b3d9fe30a3fcc8cbb37895ec2fded7bf/diff:/var/lib/docker/overlay2/e8b0842f0da5b0dbb5076e350bfe1a70ef291546bbbf207fe1f90ae7ccd64517/diff",
                "MergedDir": "/var/lib/docker/overlay2/632d2d4d01646bd8be2ec147edc70eb44f59fb262aa12b217fd560c464edd4cb/merged",
                "UpperDir": "/var/lib/docker/overlay2/632d2d4d01646bd8be2ec147edc70eb44f59fb262aa12b217fd560c464edd4cb/diff",
                "WorkDir": "/var/lib/docker/overlay2/632d2d4d01646bd8be2ec147edc70eb44f59fb262aa12b217fd560c464edd4cb/work"
            },
            "Name": "overlay2"
        },
        "RootFS": {
            "Type": "layers",
            "Layers": [
                "sha256:1dc52a6b4de8561423dd3ec5a1f7f77f5309fd8cb340f80b8bc3d87fa112003e",
                "sha256:b13a10ce059365d68a2113e9dbcac05b17b51f181615fca6d717a0dcf9ba8ffb",
                "sha256:790d00cf365a312488151b354f0b0ae826be031edffb8a4de6a1fab048774dc7",
                "sha256:323e43c53a1cd5abbd55437588f19da04f716452bc6d05486759b35f3e485390",
                "sha256:c99c9d462af0bac5511ed046178ab0de79b8cdad33cd85246e9f661e098426cd",
                "sha256:4a3a4d9fb4d250b1b64629b23bc0a477a45ee2659a8410d59a31a181dad70002",
                "sha256:27b35f432a27e5e275038e559ebbe1aa7e91447bf417f5da01e3326739ba9366",
                "sha256:ee12325fe0b7e7930b76d9a3dc81fcc37fa51a3267b311d2ed7c38703f193d75",
                "sha256:7ceb40593535cdc07299efa2ce3a2c2267c2fa683161515fd6ab97f733492bf0",
                "sha256:f18dbe0eec054f0aedf54a94aa29dab0d2c0f3d920fb482c99819622b0094f47",
                "sha256:df2a7845ea611463f9f3282ccb45156ba883f40b15013ee49bd0a569301738d8",
                "sha256:bcbd5416b87e3e37e05c22e46cbff2e3503d9caa0ec283a44931dc63e51c8cb7",
                "sha256:5bcbb3ccae766c8a72d98ce494500bfd44c32e5780a1cb153139a4c5c143a8d5",
                "sha256:4ecc8a8ffa902f3ea9bebb8d610e02a32ce1ca94c1a3160a31da98b73c1f55a0",
                "sha256:a7a7b8b26735eb2d137fd0f91b83c73ad48cf2c4b83e9d0cadece410d6e598ba",
                "sha256:ae939a0c9d32674ad6674947853ecfda4ff0530a8137960064448ae5e45fa1c5",
                "sha256:6948f39c8f3cf6ec104734ccd1112fcb4af85a7c26c9c3d43495494b9b799f25",
                "sha256:affd18c8e88f35e75bd02158e0418f3aeb4eec4269a208ede24cc829fa88c850"
            ]
        },
        "Metadata": {
            "LastTagTime": "0001-01-01T00:00:00Z"
        }
    }
]
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pass-hyperparameters-to-SKLearn-estimator">
<a class="anchor" href="#Pass-hyperparameters-to-SKLearn-estimator" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pass hyperparameters to SKLearn estimator<a class="anchor-link" href="#Pass-hyperparameters-to-SKLearn-estimator"> </a>
</h2>
<p>Let's pass some dummy hyperparameters to the estimator and see how it affects the output.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="n">script_file</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'local'</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"1.0-1"</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span><span class="s2">"dummy_param_1"</span><span class="p">:</span><span class="s2">"val1"</span><span class="p">,</span><span class="s2">"dummy_param_2"</span><span class="p">:</span><span class="s2">"val2"</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">sk_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating kc4ahx6e84-algo-1-8m8ve ... 
Creating kc4ahx6e84-algo-1-8m8ve ... done
Attaching to kc4ahx6e84-algo-1-8m8ve
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 2022-07-17 15:23:46,385 sagemaker-containers INFO     Imported framework sagemaker_sklearn_container.training
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 2022-07-17 15:23:46,389 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 2022-07-17 15:23:46,398 sagemaker_sklearn_container.training INFO     Invoking user training script.
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 2022-07-17 15:23:46,595 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 2022-07-17 15:23:46,608 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 2022-07-17 15:23:46,621 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 2022-07-17 15:23:46,630 sagemaker-training-toolkit INFO     Invoking user script
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> Training Env:
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> {
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "additional_framework_parameters": {},
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "channel_input_dirs": {},
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "current_host": "algo-1-8m8ve",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "framework_module": "sagemaker_sklearn_container.training:main",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "hosts": [
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>         "algo-1-8m8ve"
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     ],
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "hyperparameters": {
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>         "dummy_param_1": "val1",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>         "dummy_param_2": "val2"
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     },
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "input_config_dir": "/opt/ml/input/config",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "input_data_config": {},
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "input_dir": "/opt/ml/input",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "is_master": true,
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "job_name": "sagemaker-scikit-learn-2022-07-17-15-23-44-284",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "log_level": 20,
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "master_hostname": "algo-1-8m8ve",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "model_dir": "/opt/ml/model",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "module_dir": "s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-44-284/source/sourcedir.tar.gz",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "module_name": "train_and_serve",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "network_interface_name": "eth0",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "num_cpus": 2,
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "num_gpus": 0,
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "output_data_dir": "/opt/ml/output/data",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "output_dir": "/opt/ml/output",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "output_intermediate_dir": "/opt/ml/output/intermediate",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "resource_config": {
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>         "current_host": "algo-1-8m8ve",
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>         "hosts": [
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>             "algo-1-8m8ve"
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>         ]
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     },
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span>     "user_entry_point": "train_and_serve.py"
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> }
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> Environment variables:
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_HOSTS=["algo-1-8m8ve"]
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_NETWORK_INTERFACE_NAME=eth0
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_HPS={"dummy_param_1":"val1","dummy_param_2":"val2"}
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_USER_ENTRY_POINT=train_and_serve.py
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_FRAMEWORK_PARAMS={}
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_RESOURCE_CONFIG={"current_host":"algo-1-8m8ve","hosts":["algo-1-8m8ve"]}
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_INPUT_DATA_CONFIG={}
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_OUTPUT_DATA_DIR=/opt/ml/output/data
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_CHANNELS=[]
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_CURRENT_HOST=algo-1-8m8ve
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_MODULE_NAME=train_and_serve
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_LOG_LEVEL=20
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_FRAMEWORK_MODULE=sagemaker_sklearn_container.training:main
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_INPUT_DIR=/opt/ml/input
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_INPUT_CONFIG_DIR=/opt/ml/input/config
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_OUTPUT_DIR=/opt/ml/output
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_NUM_CPUS=2
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_NUM_GPUS=0
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_MODEL_DIR=/opt/ml/model
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-44-284/source/sourcedir.tar.gz
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{},"current_host":"algo-1-8m8ve","framework_module":"sagemaker_sklearn_container.training:main","hosts":["algo-1-8m8ve"],"hyperparameters":{"dummy_param_1":"val1","dummy_param_2":"val2"},"input_config_dir":"/opt/ml/input/config","input_data_config":{},"input_dir":"/opt/ml/input","is_master":true,"job_name":"sagemaker-scikit-learn-2022-07-17-15-23-44-284","log_level":20,"master_hostname":"algo-1-8m8ve","model_dir":"/opt/ml/model","module_dir":"s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-44-284/source/sourcedir.tar.gz","module_name":"train_and_serve","network_interface_name":"eth0","num_cpus":2,"num_gpus":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_host":"algo-1-8m8ve","hosts":["algo-1-8m8ve"]},"user_entry_point":"train_and_serve.py"}
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_USER_ARGS=["--dummy_param_1","val1","--dummy_param_2","val2"]
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_HP_DUMMY_PARAM_1=val1
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> SM_HP_DUMMY_PARAM_2=val2
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> PYTHONPATH=/opt/ml/code:/miniconda3/bin:/miniconda3/lib/python38.zip:/miniconda3/lib/python3.8:/miniconda3/lib/python3.8/lib-dynload:/miniconda3/lib/python3.8/site-packages
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> Invoking script with the following command:
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> /miniconda3/bin/python train_and_serve.py --dummy_param_1 val1 --dummy_param_2 val2
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> *** Hello from the SageMaker script mode***
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve |</span> 2022-07-17 15:23:46,657 sagemaker-containers INFO     Reporting training SUCCESS
<span class="ansi-cyan-fg">kc4ahx6e84-algo-1-8m8ve exited with code 0
</span>Aborting on container exit...
===== Job Complete =====
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/myblog/images/copied_from_nb/images/2022-07-07-sagemaker-script-mode/sklearn-output-hyperparams.png" alt="sklearn-output-hyperparams"></p>
<p>From the output we can see that our hyperparameters are passed to our training script as command line arguments. This is an important point and we will update our script using this information.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="SageMaker-SKLearn-container-environment-variables">
<a class="anchor" href="#SageMaker-SKLearn-container-environment-variables" aria-hidden="true"><span class="octicon octicon-link"></span></a>SageMaker SKLearn container environment variables<a class="anchor-link" href="#SageMaker-SKLearn-container-environment-variables"> </a>
</h2>
<p>Let's now discuss some important environment variables we see in the output.</p>
<h3 id="SM_MODULE_DIR">
<a class="anchor" href="#SM_MODULE_DIR" aria-hidden="true"><span class="octicon octicon-link"></span></a>SM_MODULE_DIR<a class="anchor-link" href="#SM_MODULE_DIR"> </a>
</h3>
<pre><code>SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-13-13-05-48-675/source/sourcedir.tar.gz</code></pre>
<p><code>SM_MODULE_DIR</code> points to a location in the S3 bucket where SageMaker will automatically backup our source code for that particular run. SageMaker will create a separate folder in the default bucket for each new run. The default value is <code>s3://sagemaker-{aws-region}-{aws-id}/{training-job-name}/source/sourcedir.tar.gz</code></p>
<p><strong>Note</strong>: We have used <code>local_code</code> for the SKLean estimator, then why is the source code backed up on the S3 bucket. Should it not be backed on the local system and bypass S3 altogether in local mode? Well, this should have been the default behavior, but it looks like SageMaker SDK is doing it otherwise, and even with the local mode it is using the S3 bucket for keeping source code. You can read more about this behavior in this issue ticket <a href="https://github.com/aws/sagemaker-python-sdk/issues/3031">Model repack always uploads data to S3 bucket regardless of local mode settings</a></p>
<h3 id="SM_MODEL_DIR">
<a class="anchor" href="#SM_MODEL_DIR" aria-hidden="true"><span class="octicon octicon-link"></span></a>SM_MODEL_DIR<a class="anchor-link" href="#SM_MODEL_DIR"> </a>
</h3>
<pre><code>SM_MODEL_DIR=/opt/ml/model</code></pre>
<p><code>SM_MODEL_DIR</code> points to a directory located inside the container. When the training job finishes, the container and its file system will be deleted, except for the <code>/opt/ml/model</code> and <code>/opt/ml/output</code> directories. Use <code>/opt/ml/model</code> to save the trained model artifacts. These artifacts are uploaded to S3 for model hosting.</p>
<h3 id="SM_OUTPUT_DATA_DIR">
<a class="anchor" href="#SM_OUTPUT_DATA_DIR" aria-hidden="true"><span class="octicon octicon-link"></span></a>SM_OUTPUT_DATA_DIR<a class="anchor-link" href="#SM_OUTPUT_DATA_DIR"> </a>
</h3>
<pre><code>SM_OUTPUT_DIR=/opt/ml/output</code></pre>
<p><code>SM_OUTPUT_DIR</code> points to a directory in the container to write output artifacts. Output artifacts may include checkpoints, graphs, and other files to save, not including model artifacts. These artifacts are compressed and uploaded to S3 to the same S3 prefix as the model artifacts.</p>
<h3 id="SM_CHANNELS">
<a class="anchor" href="#SM_CHANNELS" aria-hidden="true"><span class="octicon octicon-link"></span></a>SM_CHANNELS<a class="anchor-link" href="#SM_CHANNELS"> </a>
</h3>
<pre><code>SM_CHANNELS='["testing","training"]'</code></pre>
<p>A channel is a named input source that training algorithms can consume. You can partition your training data into different logical "channels" when you run training. Depending on your problem, some common channel ideas are: "training", "testing", "evaluation" or "images" and "labels". You can read more about the channels from SageMaker API reference <a href="https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_Channel.html">Channel</a></p>
<h3 id="SM-CHANNEL-{channel_name}">
<a class="anchor" href="#SM-CHANNEL-%7Bchannel_name%7D" aria-hidden="true"><span class="octicon octicon-link"></span></a>SM CHANNEL {channel_name}<a class="anchor-link" href="#SM-CHANNEL-%7Bchannel_name%7D"> </a>
</h3>
<pre><code>SM_CHANNEL_TRAIN='/opt/ml/input/data/train'
SM_CHANNEL_TEST='/opt/ml/input/data/test'</code></pre>
<p>Suppose that you have passed two input channels, 'train' and 'test', to the Scikit-learn estimator's <code>fit()</code> method, the following will be set, following the format <code>SM_CHANNEL_[channel_name]</code>:</p>
<ul>
<li>
<strong><code>SM_CHANNEL_TRAIN</code></strong>: it points to the directory in the container that has the <em>train</em> channel data downloaded</li>
<li>
<strong><code>SM_CHANNEL_TEST</code></strong>: Same as above, but for the <em>test</em> channel</li>
</ul>
<p>Note that the channel names <code>train</code> and <code>test</code> are the conventions. Still, you can use any name here, and the environment variables will be created accordingly. It is important to know that the SageMaker container automatically downloads the data from the provided input channels and makes them available in the respective local directories once it starts executing. The training script can then load the data from the local container directories.</p>
<p>There are more environment variables available, and you can read about them from <a href="https://github.com/aws/sagemaker-training-toolkit/blob/master/ENVIRONMENT_VARIABLES.md">Environment variables</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Pass-input-channel-to-SKLearn-estimator">
<a class="anchor" href="#Pass-input-channel-to-SKLearn-estimator" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pass input channel to SKLearn estimator<a class="anchor-link" href="#Pass-input-channel-to-SKLearn-estimator"> </a>
</h1>
<p>Now that we understand the SKLearn container environment more let's pass the training data channel to the estimator and see if the data becomes available inside the container directory.</p>
<p>Update our script to list all the files in the <code>SM_CHANNEL_TRAIN</code> directory.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> $script_file
<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">" *** Hello from SageMaker script container *** "</span><span class="p">)</span>

    <span class="n">training_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_CHANNEL_TRAIN"</span><span class="p">)</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">training_dir</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"training_dir files list: "</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting ./datasets/2022-07-07-sagemaker-script-mode/src/train_and_serve.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="n">script_file</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'local'</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"1.0-1"</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span><span class="s2">"dummy_param_1"</span><span class="p">:</span><span class="s2">"val1"</span><span class="p">,</span><span class="s2">"dummy_param_2"</span><span class="p">:</span><span class="s2">"val2"</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">sk_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">({</span><span class="s2">"train"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"file://</span><span class="si">{</span><span class="n">local_train_path</span><span class="si">}</span><span class="s2">"</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating wp2g5fxyg1-algo-1-o05g1 ... 
Creating wp2g5fxyg1-algo-1-o05g1 ... done
Attaching to wp2g5fxyg1-algo-1-o05g1
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 2022-07-17 15:23:49,444 sagemaker-containers INFO     Imported framework sagemaker_sklearn_container.training
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 2022-07-17 15:23:49,447 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 2022-07-17 15:23:49,456 sagemaker_sklearn_container.training INFO     Invoking user training script.
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 2022-07-17 15:23:49,638 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 2022-07-17 15:23:49,653 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 2022-07-17 15:23:49,667 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 2022-07-17 15:23:49,676 sagemaker-training-toolkit INFO     Invoking user script
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> Training Env:
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> {
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "additional_framework_parameters": {},
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "channel_input_dirs": {
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>         "train": "/opt/ml/input/data/train"
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     },
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "current_host": "algo-1-o05g1",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "framework_module": "sagemaker_sklearn_container.training:main",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "hosts": [
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>         "algo-1-o05g1"
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     ],
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "hyperparameters": {
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>         "dummy_param_1": "val1",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>         "dummy_param_2": "val2"
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     },
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "input_config_dir": "/opt/ml/input/config",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "input_data_config": {
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>         "train": {
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>         }
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     },
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "input_dir": "/opt/ml/input",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "is_master": true,
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "job_name": "sagemaker-scikit-learn-2022-07-17-15-23-47-051",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "log_level": 20,
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "master_hostname": "algo-1-o05g1",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "model_dir": "/opt/ml/model",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "module_dir": "s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-47-051/source/sourcedir.tar.gz",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "module_name": "train_and_serve",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "network_interface_name": "eth0",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "num_cpus": 2,
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "num_gpus": 0,
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "output_data_dir": "/opt/ml/output/data",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "output_dir": "/opt/ml/output",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "output_intermediate_dir": "/opt/ml/output/intermediate",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "resource_config": {
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>         "current_host": "algo-1-o05g1",
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>         "hosts": [
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>             "algo-1-o05g1"
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>         ]
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     },
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>     "user_entry_point": "train_and_serve.py"
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> }
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> Environment variables:
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_HOSTS=["algo-1-o05g1"]
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_NETWORK_INTERFACE_NAME=eth0
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_HPS={"dummy_param_1":"val1","dummy_param_2":"val2"}
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_USER_ENTRY_POINT=train_and_serve.py
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_FRAMEWORK_PARAMS={}
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_RESOURCE_CONFIG={"current_host":"algo-1-o05g1","hosts":["algo-1-o05g1"]}
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_INPUT_DATA_CONFIG={"train":{"TrainingInputMode":"File"}}
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_OUTPUT_DATA_DIR=/opt/ml/output/data
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_CHANNELS=["train"]
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_CURRENT_HOST=algo-1-o05g1
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_MODULE_NAME=train_and_serve
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_LOG_LEVEL=20
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_FRAMEWORK_MODULE=sagemaker_sklearn_container.training:main
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_INPUT_DIR=/opt/ml/input
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_INPUT_CONFIG_DIR=/opt/ml/input/config
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_OUTPUT_DIR=/opt/ml/output
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_NUM_CPUS=2
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_NUM_GPUS=0
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_MODEL_DIR=/opt/ml/model
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-47-051/source/sourcedir.tar.gz
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{"train":"/opt/ml/input/data/train"},"current_host":"algo-1-o05g1","framework_module":"sagemaker_sklearn_container.training:main","hosts":["algo-1-o05g1"],"hyperparameters":{"dummy_param_1":"val1","dummy_param_2":"val2"},"input_config_dir":"/opt/ml/input/config","input_data_config":{"train":{"TrainingInputMode":"File"}},"input_dir":"/opt/ml/input","is_master":true,"job_name":"sagemaker-scikit-learn-2022-07-17-15-23-47-051","log_level":20,"master_hostname":"algo-1-o05g1","model_dir":"/opt/ml/model","module_dir":"s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-47-051/source/sourcedir.tar.gz","module_name":"train_and_serve","network_interface_name":"eth0","num_cpus":2,"num_gpus":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_host":"algo-1-o05g1","hosts":["algo-1-o05g1"]},"user_entry_point":"train_and_serve.py"}
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_USER_ARGS=["--dummy_param_1","val1","--dummy_param_2","val2"]
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_CHANNEL_TRAIN=/opt/ml/input/data/train
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_HP_DUMMY_PARAM_1=val1
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> SM_HP_DUMMY_PARAM_2=val2
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> PYTHONPATH=/opt/ml/code:/miniconda3/bin:/miniconda3/lib/python38.zip:/miniconda3/lib/python3.8:/miniconda3/lib/python3.8/lib-dynload:/miniconda3/lib/python3.8/site-packages
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> Invoking script with the following command:
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> /miniconda3/bin/python train_and_serve.py --dummy_param_1 val1 --dummy_param_2 val2
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span>  *** Hello from SageMaker script container *** 
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> training_dir files list:  ['train.csv']
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 |</span> 2022-07-17 15:23:49,715 sagemaker-containers INFO     Reporting training SUCCESS
<span class="ansi-cyan-fg">wp2g5fxyg1-algo-1-o05g1 exited with code 0
</span>Aborting on container exit...
===== Job Complete =====
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/myblog/images/copied_from_nb/images/2022-07-07-sagemaker-script-mode/sklearn-output-traincsv.png" alt="sklearn-output-traincsv"></p>
<p>From the output, we can see that <code>train.csv</code>, which was in our local environment, is now available inside the container on path <code>SM_CHANNEL_TRAIN=/opt/ml/input/data/train</code>.</p>
<p>Let's also test the same with our training data on the S3 bucket.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="n">script_file</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'local'</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"1.0-1"</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span><span class="s2">"dummy_param_1"</span><span class="p">:</span><span class="s2">"val1"</span><span class="p">,</span><span class="s2">"dummy_param_2"</span><span class="p">:</span><span class="s2">"val2"</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">sk_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">({</span><span class="s2">"train"</span><span class="p">:</span> <span class="n">s3_train_uri</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating 7ao431iiu5-algo-1-9jid1 ... 
Creating 7ao431iiu5-algo-1-9jid1 ... done
Attaching to 7ao431iiu5-algo-1-9jid1
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 2022-07-17 15:23:53,073 sagemaker-containers INFO     Imported framework sagemaker_sklearn_container.training
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 2022-07-17 15:23:53,079 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 2022-07-17 15:23:53,094 sagemaker_sklearn_container.training INFO     Invoking user training script.
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 2022-07-17 15:23:53,335 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 2022-07-17 15:23:53,348 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 2022-07-17 15:23:53,360 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 2022-07-17 15:23:53,369 sagemaker-training-toolkit INFO     Invoking user script
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> Training Env:
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> {
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "additional_framework_parameters": {},
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "channel_input_dirs": {
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>         "train": "/opt/ml/input/data/train"
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     },
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "current_host": "algo-1-9jid1",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "framework_module": "sagemaker_sklearn_container.training:main",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "hosts": [
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>         "algo-1-9jid1"
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     ],
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "hyperparameters": {
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>         "dummy_param_1": "val1",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>         "dummy_param_2": "val2"
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     },
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "input_config_dir": "/opt/ml/input/config",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "input_data_config": {
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>         "train": {
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>         }
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     },
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "input_dir": "/opt/ml/input",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "is_master": true,
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "job_name": "sagemaker-scikit-learn-2022-07-17-15-23-50-077",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "log_level": 20,
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "master_hostname": "algo-1-9jid1",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "model_dir": "/opt/ml/model",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "module_dir": "s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-50-077/source/sourcedir.tar.gz",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "module_name": "train_and_serve",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "network_interface_name": "eth0",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "num_cpus": 2,
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "num_gpus": 0,
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "output_data_dir": "/opt/ml/output/data",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "output_dir": "/opt/ml/output",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "output_intermediate_dir": "/opt/ml/output/intermediate",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "resource_config": {
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>         "current_host": "algo-1-9jid1",
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>         "hosts": [
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>             "algo-1-9jid1"
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>         ]
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     },
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>     "user_entry_point": "train_and_serve.py"
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> }
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> Environment variables:
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_HOSTS=["algo-1-9jid1"]
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_NETWORK_INTERFACE_NAME=eth0
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_HPS={"dummy_param_1":"val1","dummy_param_2":"val2"}
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_USER_ENTRY_POINT=train_and_serve.py
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_FRAMEWORK_PARAMS={}
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_RESOURCE_CONFIG={"current_host":"algo-1-9jid1","hosts":["algo-1-9jid1"]}
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_INPUT_DATA_CONFIG={"train":{"TrainingInputMode":"File"}}
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_OUTPUT_DATA_DIR=/opt/ml/output/data
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_CHANNELS=["train"]
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_CURRENT_HOST=algo-1-9jid1
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_MODULE_NAME=train_and_serve
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_LOG_LEVEL=20
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_FRAMEWORK_MODULE=sagemaker_sklearn_container.training:main
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_INPUT_DIR=/opt/ml/input
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_INPUT_CONFIG_DIR=/opt/ml/input/config
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_OUTPUT_DIR=/opt/ml/output
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_NUM_CPUS=2
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_NUM_GPUS=0
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_MODEL_DIR=/opt/ml/model
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-50-077/source/sourcedir.tar.gz
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{"train":"/opt/ml/input/data/train"},"current_host":"algo-1-9jid1","framework_module":"sagemaker_sklearn_container.training:main","hosts":["algo-1-9jid1"],"hyperparameters":{"dummy_param_1":"val1","dummy_param_2":"val2"},"input_config_dir":"/opt/ml/input/config","input_data_config":{"train":{"TrainingInputMode":"File"}},"input_dir":"/opt/ml/input","is_master":true,"job_name":"sagemaker-scikit-learn-2022-07-17-15-23-50-077","log_level":20,"master_hostname":"algo-1-9jid1","model_dir":"/opt/ml/model","module_dir":"s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-50-077/source/sourcedir.tar.gz","module_name":"train_and_serve","network_interface_name":"eth0","num_cpus":2,"num_gpus":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_host":"algo-1-9jid1","hosts":["algo-1-9jid1"]},"user_entry_point":"train_and_serve.py"}
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_USER_ARGS=["--dummy_param_1","val1","--dummy_param_2","val2"]
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_CHANNEL_TRAIN=/opt/ml/input/data/train
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_HP_DUMMY_PARAM_1=val1
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> SM_HP_DUMMY_PARAM_2=val2
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> PYTHONPATH=/opt/ml/code:/miniconda3/bin:/miniconda3/lib/python38.zip:/miniconda3/lib/python3.8:/miniconda3/lib/python3.8/lib-dynload:/miniconda3/lib/python3.8/site-packages
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> Invoking script with the following command:
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> /miniconda3/bin/python train_and_serve.py --dummy_param_1 val1 --dummy_param_2 val2
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span>  *** Hello from SageMaker script container *** 
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> training_dir files list:  ['train.csv']
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 |</span> 2022-07-17 15:23:53,409 sagemaker-containers INFO     Reporting training SUCCESS
<span class="ansi-cyan-fg">7ao431iiu5-algo-1-9jid1 exited with code 0
</span>Aborting on container exit...
===== Job Complete =====
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Again the results are the same. SageMaker will download the data from the S3 bucket and make it available in the container. In the environment variables section we also learned that two directories are special <code>/opt/ml/model</code> and <code>/opt/ml/output</code>. Container environment variables <code>SM_MODEL_DIR</code> and <code>SM_OUTPUT_DATA_DIR</code> point to them, respectively. Whatever artifacts we put on them will be stored on the S3 bucket when the training job finishes. "SM_MODEL_DIR" is for trained models, and "SM_OUTPUT_DATA_DIR" is for other artifacts like logs, graphs, plots, results, etc. Let's update our training script and put some dummy data in these directories. Once the job is complete, we will verify the stored artifacts on the S3 bucket.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> $script_file
<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">" *** Hello from SageMaker script container *** "</span><span class="p">)</span>

    <span class="c1"># list files in SM_CHANNEL_TRAIN</span>
    <span class="n">training_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_CHANNEL_TRAIN"</span><span class="p">)</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">training_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"training_dir files list: "</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">)</span>

    <span class="c1"># write dummy model file to SM_MODEL_DIR</span>
    <span class="n">sm_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_MODEL_DIR"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">sm_model_dir</span><span class="si">}</span><span class="s2">/dummy-model.txt"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"this is a dummy model"</span><span class="p">)</span>

    <span class="c1"># write dummy artifact file to SM_OUTPUT_DATA_DIR</span>
    <span class="n">sm_output_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_OUTPUT_DATA_DIR"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">sm_output_data_dir</span><span class="si">}</span><span class="s2">/dummy-output-data.txt"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"this is a dummy output data"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting ./datasets/2022-07-07-sagemaker-script-mode/src/train_and_serve.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="n">script_file</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'local'</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"1.0-1"</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span><span class="s2">"dummy_param_1"</span><span class="p">:</span><span class="s2">"val1"</span><span class="p">,</span><span class="s2">"dummy_param_2"</span><span class="p">:</span><span class="s2">"val2"</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">sk_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">({</span><span class="s2">"train"</span><span class="p">:</span> <span class="n">s3_train_uri</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating c30093mavu-algo-1-p87y9 ... 
Creating c30093mavu-algo-1-p87y9 ... done
Attaching to c30093mavu-algo-1-p87y9
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 2022-07-17 15:23:56,051 sagemaker-containers INFO     Imported framework sagemaker_sklearn_container.training
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 2022-07-17 15:23:56,055 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 2022-07-17 15:23:56,065 sagemaker_sklearn_container.training INFO     Invoking user training script.
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 2022-07-17 15:23:56,251 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 2022-07-17 15:23:56,267 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 2022-07-17 15:23:56,281 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 2022-07-17 15:23:56,291 sagemaker-training-toolkit INFO     Invoking user script
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> Training Env:
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> {
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "additional_framework_parameters": {},
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "channel_input_dirs": {
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>         "train": "/opt/ml/input/data/train"
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     },
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "current_host": "algo-1-p87y9",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "framework_module": "sagemaker_sklearn_container.training:main",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "hosts": [
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>         "algo-1-p87y9"
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     ],
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "hyperparameters": {
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>         "dummy_param_1": "val1",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>         "dummy_param_2": "val2"
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     },
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "input_config_dir": "/opt/ml/input/config",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "input_data_config": {
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>         "train": {
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>         }
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     },
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "input_dir": "/opt/ml/input",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "is_master": true,
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "job_name": "sagemaker-scikit-learn-2022-07-17-15-23-53-775",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "log_level": 20,
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "master_hostname": "algo-1-p87y9",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "model_dir": "/opt/ml/model",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "module_dir": "s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-53-775/source/sourcedir.tar.gz",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "module_name": "train_and_serve",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "network_interface_name": "eth0",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "num_cpus": 2,
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "num_gpus": 0,
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "output_data_dir": "/opt/ml/output/data",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "output_dir": "/opt/ml/output",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "output_intermediate_dir": "/opt/ml/output/intermediate",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "resource_config": {
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>         "current_host": "algo-1-p87y9",
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>         "hosts": [
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>             "algo-1-p87y9"
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>         ]
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     },
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>     "user_entry_point": "train_and_serve.py"
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> }
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> Environment variables:
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_HOSTS=["algo-1-p87y9"]
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_NETWORK_INTERFACE_NAME=eth0
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_HPS={"dummy_param_1":"val1","dummy_param_2":"val2"}
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_USER_ENTRY_POINT=train_and_serve.py
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_FRAMEWORK_PARAMS={}
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_RESOURCE_CONFIG={"current_host":"algo-1-p87y9","hosts":["algo-1-p87y9"]}
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_INPUT_DATA_CONFIG={"train":{"TrainingInputMode":"File"}}
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_OUTPUT_DATA_DIR=/opt/ml/output/data
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_CHANNELS=["train"]
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_CURRENT_HOST=algo-1-p87y9
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_MODULE_NAME=train_and_serve
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_LOG_LEVEL=20
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_FRAMEWORK_MODULE=sagemaker_sklearn_container.training:main
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_INPUT_DIR=/opt/ml/input
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_INPUT_CONFIG_DIR=/opt/ml/input/config
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_OUTPUT_DIR=/opt/ml/output
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_NUM_CPUS=2
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_NUM_GPUS=0
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_MODEL_DIR=/opt/ml/model
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-53-775/source/sourcedir.tar.gz
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{"train":"/opt/ml/input/data/train"},"current_host":"algo-1-p87y9","framework_module":"sagemaker_sklearn_container.training:main","hosts":["algo-1-p87y9"],"hyperparameters":{"dummy_param_1":"val1","dummy_param_2":"val2"},"input_config_dir":"/opt/ml/input/config","input_data_config":{"train":{"TrainingInputMode":"File"}},"input_dir":"/opt/ml/input","is_master":true,"job_name":"sagemaker-scikit-learn-2022-07-17-15-23-53-775","log_level":20,"master_hostname":"algo-1-p87y9","model_dir":"/opt/ml/model","module_dir":"s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-53-775/source/sourcedir.tar.gz","module_name":"train_and_serve","network_interface_name":"eth0","num_cpus":2,"num_gpus":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_host":"algo-1-p87y9","hosts":["algo-1-p87y9"]},"user_entry_point":"train_and_serve.py"}
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_USER_ARGS=["--dummy_param_1","val1","--dummy_param_2","val2"]
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_CHANNEL_TRAIN=/opt/ml/input/data/train
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_HP_DUMMY_PARAM_1=val1
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> SM_HP_DUMMY_PARAM_2=val2
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> PYTHONPATH=/opt/ml/code:/miniconda3/bin:/miniconda3/lib/python38.zip:/miniconda3/lib/python3.8:/miniconda3/lib/python3.8/lib-dynload:/miniconda3/lib/python3.8/site-packages
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> Invoking script with the following command:
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> /miniconda3/bin/python train_and_serve.py --dummy_param_1 val1 --dummy_param_2 val2
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span>  *** Hello from SageMaker script container *** 
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> training_dir files list:  ['train.csv']
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 |</span> 2022-07-17 15:23:56,328 sagemaker-containers INFO     Reporting training SUCCESS
<span class="ansi-cyan-fg">c30093mavu-algo-1-p87y9 exited with code 0
</span>Aborting on container exit...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Failed to delete: /tmp/tmpuwvrle8_/algo-1-p87y9 Please remove it manually.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>===== Job Complete =====
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our training job is now complete. Let us check the S3 bucket to see if our dummy model and other artifacts are present.</p>
<p>First, we need the S3 URI for these artifacts. For our dummy model (from SM_MODEL_DIR), we can use our estimator object to get the URI.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_data</span> <span class="o">=</span> <span class="n">sk_estimator</span><span class="o">.</span><span class="n">model_data</span>
<span class="n">model_data</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-53-775/model.tar.gz'</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's download <code>model_data</code> from S3 to a local directory for verification. For this create a local <code>/tmp</code> to store these downloaded files.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">local_tmp_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">+</span> <span class="s2">"/tmp"</span>
<span class="nb">print</span><span class="p">(</span><span class="n">local_tmp_path</span><span class="p">)</span>

<span class="c1"># create the local '/tmp' directory</span>
<span class="n">Path</span><span class="p">(</span><span class="n">local_tmp_path</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>./datasets/2022-07-07-sagemaker-script-mode/tmp
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We will use SageMaker <code>S3Downloader</code> object to download the model file.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sagemaker.s3</span> <span class="kn">import</span> <span class="n">S3Downloader</span>

<span class="n">S3Downloader</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
    <span class="n">s3_uri</span><span class="o">=</span><span class="n">model_data</span><span class="p">,</span> <span class="n">local_path</span><span class="o">=</span><span class="n">local_tmp_path</span><span class="p">,</span> <span class="n">sagemaker_session</span><span class="o">=</span><span class="n">session</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>File is downloaded. Let's uncompress it to verify the model file.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>tar -xzvf <span class="nv">$local_tmp_path</span>/model.tar.gz -C <span class="nv">$local_tmp_path</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>dummy-model.txt
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Yes, the "dummy-model.txt" file is present. This tells us that SageMaker will automatically upload the files from the model directory (SM_MODEL_DIR) to the S3 bucket. Let's do the same for the output data directory (SM_OUTPUT_DATA_DIR). There is no direct way to get the S3 URI from the estimator object for the output data directory. But we can prepare it ourselves. So let's do that next.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"estimator.output_path: "</span><span class="p">,</span> <span class="n">sk_estimator</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"estimator.latest_training_job.name: "</span><span class="p">,</span> <span class="n">sk_estimator</span><span class="o">.</span><span class="n">latest_training_job</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>estimator.output_path:  s3://sagemaker-us-east-1-801598032724/
estimator.latest_training_job.name:  sagemaker-scikit-learn-2022-07-17-15-23-53-775
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_s3_output_uri</span><span class="p">(</span><span class="n">estimator</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">estimator</span><span class="o">.</span><span class="n">output_path</span> <span class="o">+</span> <span class="n">estimator</span><span class="o">.</span><span class="n">latest_training_job</span><span class="o">.</span><span class="n">name</span>
    
<span class="n">get_s3_output_uri</span><span class="p">(</span><span class="n">sk_estimator</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-53-775'</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># S3 URI for output data artifacts</span>
<span class="n">s3_output_uri</span> <span class="o">=</span> <span class="n">get_s3_output_uri</span><span class="p">(</span><span class="n">sk_estimator</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'/output.tar.gz'</span>
<span class="n">s3_output_uri</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-53-775/output.tar.gz'</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># S3 URI for model artifact. We have already veirifed it.</span>
<span class="n">s3_model_uri</span> <span class="o">=</span> <span class="n">get_s3_output_uri</span><span class="p">(</span><span class="n">sk_estimator</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'/model.tar.gz'</span>
<span class="n">s3_model_uri</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-53-775/model.tar.gz'</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># S3 URI for source code</span>
<span class="n">s3_source_uri</span> <span class="o">=</span> <span class="n">get_s3_output_uri</span><span class="p">(</span><span class="n">sk_estimator</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'/source/sourcedir.tar.gz'</span>
<span class="n">s3_source_uri</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-53-775/source/sourcedir.tar.gz'</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's download these artifacts to our local '/tmp' directory for verification.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>aws s3 cp <span class="nv">$s3_output_uri</span> <span class="nv">$local_tmp_path</span>
<span class="o">!</span>aws s3 cp <span class="nv">$s3_source_uri</span> <span class="nv">$local_tmp_path</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>download: s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-53-775/output.tar.gz to datasets/2022-07-07-sagemaker-script-mode/tmp/output.tar.gz
download: s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-23-53-775/source/sourcedir.tar.gz to datasets/2022-07-07-sagemaker-script-mode/tmp/sourcedir.tar.gz
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># extract the output data files from 'output.tar.gz'</span>
<span class="o">!</span>tar -xzvf <span class="nv">$local_tmp_path</span>/output.tar.gz -C <span class="nv">$local_tmp_path</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>data/
data/dummy-output-data.txt
success
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># extract the source code files from 'sourcedir.tar.gz'</span>
<span class="o">!</span>tar -xzvf <span class="nv">$local_tmp_path</span>/sourcedir.tar.gz -C <span class="nv">$local_tmp_path</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>train_and_serve.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Summary-till-now">
<a class="anchor" href="#Summary-till-now" aria-hidden="true"><span class="octicon octicon-link"></span></a>Summary till now<a class="anchor-link" href="#Summary-till-now"> </a>
</h1>
<p>Let's summarize what we have learned till now.</p>
<ul>
<li>We can use SageMaker SKLearn local mode to test our code in a local environment</li>
<li>SKLearn container executes our provided script with the command <code>/miniconda3/bin/python train_and_server.py</code>
</li>
<li>Hyperparameters passed to the container are passed to our script as command line arguments</li>
<li>Data from input channels will be downloaded by the container and made available for our script to load and process</li>
<li>'/opt/ml/model' and '/opt/ml/output' directories are special. Anything stored on them will be automatically backed up on the S3 bucket when the job finishes. These directories are defined in the container environment variables 'SM_MODEL_DIR' and 'SM_OUTPUT_DATA_DIR', respectively. SM_MODEL_DIR should be used to write model artifacts. SM_OUTPUT_DATA_DIR should be used to write any other supporting artifact.</li>
</ul>
<p>Let's use this knowledge to update our script to train a RandomForrestClassifier on the Iris flower dataset.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># cleanup /tmp directory before moving to next section</span>
<span class="o">!</span>rm -r <span class="nv">$local_tmp_path</span>/*
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Prepare-training-script-for-RandomForestClassifier">
<a class="anchor" href="#Prepare-training-script-for-RandomForestClassifier" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prepare training script for RandomForestClassifier<a class="anchor-link" href="#Prepare-training-script-for-RandomForestClassifier"> </a>
</h1>
<p>Let's update our training script to train a scikit-learn random forest classifier model on the iris data set. The script will read training and testing data from input data channel directories and trains a classifier on it. It will then save the model to the model directory and validation results ('y_pred.csv') to the output data directory. Notice that we have also parsed container environment variables as command line arguments. It makes sense for hyperparameters ('--estimators') because we know they will be passed to the script as command line parameters. For other environment variables (e.g. 'SM_MODEL_DIR'), we have checked first if they are given as command line arguments. If they are, then we parse them to get the values. Otherwise, we read their values from the environment. This is done so we can test our script locally from the command line without setting the environment variables.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> $script_file

<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>

    <span class="c1"># Pass in environment variables and hyperparameters</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="c1"># Hyperparameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--estimators"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="c1"># sm_model_dir: model artifacts stored here after training</span>
    <span class="c1"># sm-channel-train: input training data location</span>
    <span class="c1"># sm-channel-test: input test data location</span>
    <span class="c1"># sm-output-data-dir: output artifacts location</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-model-dir"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_MODEL_DIR"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-channel-train"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_CHANNEL_TRAIN"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-channel-test"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_CHANNEL_TEST"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-output-data-dir"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_OUTPUT_DATA_DIR"</span><span class="p">))</span>

    <span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"command line arguments: "</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="n">estimators</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">estimators</span>
    <span class="n">sm_model_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_model_dir</span>
    <span class="n">training_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_channel_train</span>
    <span class="n">testing_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_channel_test</span>
    <span class="n">output_data_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_output_data_dir</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"training_dir: </span><span class="si">{</span><span class="n">training_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"training_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">training_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"testing_dir: </span><span class="si">{</span><span class="n">testing_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"testing_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">testing_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sm_model_dir: </span><span class="si">{</span><span class="n">sm_model_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"output_data_dir: </span><span class="si">{</span><span class="n">output_data_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Read in data</span>
    <span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">training_dir</span> <span class="o">+</span> <span class="s2">"/train.csv"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">testing_dir</span> <span class="o">+</span> <span class="s2">"/test.csv"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>

    <span class="c1"># Preprocess data</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"class_cat"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">"class_cat"</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"class_cat"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">"class_cat"</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"X_train.shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y_train.shape: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"X_train.shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y_train.shape: </span><span class="si">{</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Build model</span>
    <span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">)</span>
    <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Save the model</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">regressor</span><span class="p">,</span> <span class="n">sm_model_dir</span> <span class="o">+</span> <span class="s2">"/model.joblib"</span><span class="p">)</span>

    <span class="c1"># Save the results</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_data_dir</span> <span class="o">+</span> <span class="s2">"/y_pred.csv"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting ./datasets/2022-07-07-sagemaker-script-mode/src/train_and_serve.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now give proper execution rights to the script.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>chmod +x <span class="nv">$script_file</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's test this script locally before passing it to the SKLearn estimator. We will invoke this script from a command line and pass the required parameters similar to how an estimator container will execute it. For testing this script, we need to pass four directory paths:</p>
<ul>
<li>
<strong>sm-model-dir</strong> This will point to a directory where our script will store the trained model. We can point it to '/tmp' directory for test purposes</li>
<li>
<strong>sm-channel-train</strong> This will point to a directory containing training data. We already have it as 'local_train_path'</li>
<li>
<strong>sm-channel-test</strong> This will point to a directory containing test data. We also have it as 'local_test_path'</li>
<li>
<strong>sm-output-data-dir</strong> This will point to a directory where our script will store other artifacts. We can also point it to '/tmp' directory for test purposes</li>
</ul>
<p>Once the script is successfully run, we will find the trained model file 'model.joblib' and 'y_pred.csv' in the '/tmp' directory.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>python3 <span class="nv">$script_file</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">sm</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="n">local_tmp_path</span> \
    <span class="o">--</span><span class="n">sm</span><span class="o">-</span><span class="n">channel</span><span class="o">-</span><span class="n">train</span> <span class="err">$</span><span class="n">local_train_path</span> \
    <span class="o">--</span><span class="n">sm</span><span class="o">-</span><span class="n">channel</span><span class="o">-</span><span class="n">test</span> <span class="err">$</span><span class="n">local_test_path</span> \
    <span class="o">--</span><span class="n">sm</span><span class="o">-</span><span class="n">output</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="n">local_tmp_path</span> \
    <span class="o">--</span><span class="n">estimators</span> <span class="mi">10</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>command line arguments:  Namespace(estimators=10, sm_channel_test='./datasets/2022-07-07-sagemaker-script-mode/test', sm_channel_train='./datasets/2022-07-07-sagemaker-script-mode/train', sm_model_dir='./datasets/2022-07-07-sagemaker-script-mode/tmp', sm_output_data_dir='./datasets/2022-07-07-sagemaker-script-mode/tmp')
training_dir: ./datasets/2022-07-07-sagemaker-script-mode/train
training_dir files list: ['train.csv']
testing_dir: ./datasets/2022-07-07-sagemaker-script-mode/test
testing_dir files list: ['test.csv']
sm_model_dir: ./datasets/2022-07-07-sagemaker-script-mode/tmp
output_data_dir: ./datasets/2022-07-07-sagemaker-script-mode/tmp
X_train.shape: (120, 4)
y_train.shape: (120,)
X_train.shape: (30, 4)
y_train.shape: (30,)
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's check the local '/tmp' directory for artifacts.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls <span class="nv">$local_tmp_path</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>model.joblib  y_pred.csv
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have test our script and it is working as expected, let's pass it to SKLean container.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="n">script_file</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'local'</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"1.0-1"</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span><span class="s2">"estimators"</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">sk_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">({</span><span class="s2">"train"</span><span class="p">:</span> <span class="n">s3_train_uri</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">:</span> <span class="n">s3_test_uri</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating aer2alr1w1-algo-1-10beq ... 
Creating aer2alr1w1-algo-1-10beq ... done
Attaching to aer2alr1w1-algo-1-10beq
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 2022-07-17 15:24:06,011 sagemaker-containers INFO     Imported framework sagemaker_sklearn_container.training
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 2022-07-17 15:24:06,015 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 2022-07-17 15:24:06,024 sagemaker_sklearn_container.training INFO     Invoking user training script.
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 2022-07-17 15:24:06,226 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 2022-07-17 15:24:06,239 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 2022-07-17 15:24:06,251 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 2022-07-17 15:24:06,260 sagemaker-training-toolkit INFO     Invoking user script
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> Training Env:
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> {
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "additional_framework_parameters": {},
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "channel_input_dirs": {
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         "train": "/opt/ml/input/data/train",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         "test": "/opt/ml/input/data/test"
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     },
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "current_host": "algo-1-10beq",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "framework_module": "sagemaker_sklearn_container.training:main",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "hosts": [
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         "algo-1-10beq"
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     ],
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "hyperparameters": {
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         "estimators": 10
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     },
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "input_config_dir": "/opt/ml/input/config",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "input_data_config": {
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         "train": {
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         },
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         "test": {
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         }
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     },
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "input_dir": "/opt/ml/input",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "is_master": true,
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "job_name": "sagemaker-scikit-learn-2022-07-17-15-24-03-447",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "log_level": 20,
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "master_hostname": "algo-1-10beq",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "model_dir": "/opt/ml/model",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "module_dir": "s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-24-03-447/source/sourcedir.tar.gz",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "module_name": "train_and_serve",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "network_interface_name": "eth0",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "num_cpus": 2,
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "num_gpus": 0,
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "output_data_dir": "/opt/ml/output/data",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "output_dir": "/opt/ml/output",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "output_intermediate_dir": "/opt/ml/output/intermediate",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "resource_config": {
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         "current_host": "algo-1-10beq",
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         "hosts": [
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>             "algo-1-10beq"
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>         ]
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     },
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span>     "user_entry_point": "train_and_serve.py"
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> }
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> Environment variables:
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_HOSTS=["algo-1-10beq"]
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_NETWORK_INTERFACE_NAME=eth0
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_HPS={"estimators":10}
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_USER_ENTRY_POINT=train_and_serve.py
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_FRAMEWORK_PARAMS={}
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_RESOURCE_CONFIG={"current_host":"algo-1-10beq","hosts":["algo-1-10beq"]}
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_INPUT_DATA_CONFIG={"test":{"TrainingInputMode":"File"},"train":{"TrainingInputMode":"File"}}
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_OUTPUT_DATA_DIR=/opt/ml/output/data
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_CHANNELS=["test","train"]
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_CURRENT_HOST=algo-1-10beq
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_MODULE_NAME=train_and_serve
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_LOG_LEVEL=20
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_FRAMEWORK_MODULE=sagemaker_sklearn_container.training:main
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_INPUT_DIR=/opt/ml/input
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_INPUT_CONFIG_DIR=/opt/ml/input/config
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_OUTPUT_DIR=/opt/ml/output
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_NUM_CPUS=2
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_NUM_GPUS=0
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_MODEL_DIR=/opt/ml/model
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-24-03-447/source/sourcedir.tar.gz
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{"test":"/opt/ml/input/data/test","train":"/opt/ml/input/data/train"},"current_host":"algo-1-10beq","framework_module":"sagemaker_sklearn_container.training:main","hosts":["algo-1-10beq"],"hyperparameters":{"estimators":10},"input_config_dir":"/opt/ml/input/config","input_data_config":{"test":{"TrainingInputMode":"File"},"train":{"TrainingInputMode":"File"}},"input_dir":"/opt/ml/input","is_master":true,"job_name":"sagemaker-scikit-learn-2022-07-17-15-24-03-447","log_level":20,"master_hostname":"algo-1-10beq","model_dir":"/opt/ml/model","module_dir":"s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-24-03-447/source/sourcedir.tar.gz","module_name":"train_and_serve","network_interface_name":"eth0","num_cpus":2,"num_gpus":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_host":"algo-1-10beq","hosts":["algo-1-10beq"]},"user_entry_point":"train_and_serve.py"}
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_USER_ARGS=["--estimators","10"]
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_CHANNEL_TRAIN=/opt/ml/input/data/train
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_CHANNEL_TEST=/opt/ml/input/data/test
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> SM_HP_ESTIMATORS=10
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> PYTHONPATH=/opt/ml/code:/miniconda3/bin:/miniconda3/lib/python38.zip:/miniconda3/lib/python3.8:/miniconda3/lib/python3.8/lib-dynload:/miniconda3/lib/python3.8/site-packages
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> Invoking script with the following command:
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> /miniconda3/bin/python train_and_serve.py --estimators 10
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> command line arguments:  Namespace(estimators=10, sm_channel_test='/opt/ml/input/data/test', sm_channel_train='/opt/ml/input/data/train', sm_model_dir='/opt/ml/model', sm_output_data_dir='/opt/ml/output/data')
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> training_dir: /opt/ml/input/data/train
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> training_dir files list: ['train.csv']
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> testing_dir: /opt/ml/input/data/test
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> testing_dir files list: ['test.csv']
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> sm_model_dir: /opt/ml/model
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> output_data_dir: /opt/ml/output/data
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> X_train.shape: (120, 4)
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> y_train.shape: (120,)
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> X_train.shape: (30, 4)
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> y_train.shape: (30,)
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq |</span> 2022-07-17 15:24:07,286 sagemaker-containers INFO     Reporting training SUCCESS
<span class="ansi-cyan-fg">aer2alr1w1-algo-1-10beq exited with code 0
</span>Aborting on container exit...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Failed to delete: /tmp/tmp0yb8k7nj/algo-1-10beq Please remove it manually.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>===== Job Complete =====
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># cleanup /tmp directory before moving to next section</span>
<span class="o">!</span>rm -r <span class="nv">$local_tmp_path</span>/*
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Passing-custom-libraries-and-dependencies-to-SKLean-container">
<a class="anchor" href="#Passing-custom-libraries-and-dependencies-to-SKLean-container" aria-hidden="true"><span class="octicon octicon-link"></span></a>Passing custom libraries and dependencies to SKLean container<a class="anchor-link" href="#Passing-custom-libraries-and-dependencies-to-SKLean-container"> </a>
</h1>
<p>We have successfully trained our classifier but assume we have an additional task. One of your colleagues has created a library that takes the confusion matrix array and plots it with <a href="https://seaborn.pydata.org/">seaborn visualization library</a>. You have been told to use this custom library with the training script and save the confusion matrix plot to the output data directory.</p>
<p>Let's prepare code for this custom library to take an array and return a confusion matrix plot from seaborn.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">custom_library_path</span> <span class="o">=</span> <span class="n">local_path</span> <span class="o">+</span> <span class="s2">"/my_custom_library"</span>
<span class="n">custom_library_file</span> <span class="o">=</span> <span class="n">custom_library_path</span> <span class="o">+</span> <span class="s2">"/seaborn_confusion_matrix.py"</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"custom_library_path: </span><span class="si">{</span><span class="n">custom_library_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"custom_library_file: </span><span class="si">{</span><span class="n">custom_library_file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># make sure the path exists</span>
<span class="n">Path</span><span class="p">(</span><span class="n">custom_library_path</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>custom_library_path: ./datasets/2022-07-07-sagemaker-script-mode/my_custom_library
custom_library_file: ./datasets/2022-07-07-sagemaker-script-mode/my_custom_library/seaborn_confusion_matrix.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now the code to plot the confusion matrix.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> $custom_library_file

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">save_confusion_matrix</span><span class="p">(</span><span class="n">cf_matrix</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">"./"</span><span class="p">):</span>
    <span class="n">sns_plot</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cf_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sns_plot</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">"/output_cm.png"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--path"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">"./"</span><span class="p">)</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">path</span>

    <span class="n">dummy_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">23</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">30</span><span class="p">]])</span>
    <span class="n">save_confusion_matrix</span><span class="p">(</span><span class="n">dummy_cm</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting ./datasets/2022-07-07-sagemaker-script-mode/my_custom_library/seaborn_confusion_matrix.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Convert the directory containing seaborn code into a Python package directory.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> $custom_library_path/__init__.py

<span class="kn">from</span> <span class="nn">.seaborn_confusion_matrix</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting ./datasets/2022-07-07-sagemaker-script-mode/my_custom_library/__init__.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our custom library has a dependency on the <a href="https://seaborn.pydata.org/">seaborn Python package</a>. So let's create 'requirements.txt' and put all our dependencies in it. Later it will be passed to the SKLean container to install them during initialization.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> $script_path/requirements.txt

<span class="n">seaborn</span><span class="o">==</span><span class="mf">0.11</span><span class="o">.</span><span class="mi">2</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's first test this library in our local environment. It should plot a dummy confusion matrix in local <code>/tmp</code> directory.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># intall the dependiencies first</span>
<span class="o">!</span>pip install -r <span class="nv">$script_path</span>/requirements.txt
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Looking in indexes: https://pypi.org/simple, https://pip.repos.neuron.amazonaws.com
Requirement already satisfied: seaborn==0.11.2 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from -r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (0.11.2)
Requirement already satisfied: numpy&gt;=1.15 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (1.20.3)
Requirement already satisfied: matplotlib&gt;=2.2 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (3.5.0)
Requirement already satisfied: scipy&gt;=1.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (1.5.3)
Requirement already satisfied: pandas&gt;=0.23 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (1.3.4)
Requirement already satisfied: fonttools&gt;=4.22.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (4.28.2)
Requirement already satisfied: python-dateutil&gt;=2.7 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (2.8.2)
Requirement already satisfied: kiwisolver&gt;=1.0.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (1.3.2)
Requirement already satisfied: pillow&gt;=6.2.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (9.0.1)
Requirement already satisfied: packaging&gt;=20.0 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (21.3)
Requirement already satisfied: pyparsing&gt;=2.2.1 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (3.0.6)
Requirement already satisfied: cycler&gt;=0.10 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (0.11.0)
Requirement already satisfied: pytz&gt;=2017.3 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from pandas&gt;=0.23-&gt;seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (2021.3)
Requirement already satisfied: six&gt;=1.5 in /home/ec2-user/anaconda3/envs/python3/lib/python3.8/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r ./datasets/2022-07-07-sagemaker-script-mode/src/requirements.txt (line 2)) (1.16.0)
<span class="ansi-yellow-fg">WARNING: You are using pip version 22.0.4; however, version 22.1.2 is available.
You should consider upgrading via the '/home/ec2-user/anaconda3/envs/python3/bin/python -m pip install --upgrade pip' command.</span><span class="ansi-yellow-fg">
</span></pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># test the custom library</span>
<span class="o">!</span>python3 <span class="nv">$custom_library_file</span> --path <span class="nv">$local_tmp_path</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Matplotlib is building the font cache; this may take a moment.
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># verify the custom library output from the /tmp directory</span>
<span class="o">!</span>ls <span class="nv">$local_tmp_path</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>output_cm.png
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So our custom library code works. Let's update our script to use it.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> $script_file

<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="kn">from</span> <span class="nn">my_custom_library</span> <span class="kn">import</span> <span class="n">save_confusion_matrix</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>

    <span class="c1"># Pass in environment variables and hyperparameters</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="c1"># Hyperparameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--estimators"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="c1"># sm_model_dir: model artifacts stored here after training</span>
    <span class="c1"># sm-channel-train: input training data location</span>
    <span class="c1"># sm-channel-test: input test data location</span>
    <span class="c1"># sm-output-data-dir: output artifacts location</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-model-dir"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_MODEL_DIR"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-channel-train"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_CHANNEL_TRAIN"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-channel-test"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_CHANNEL_TEST"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-output-data-dir"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_OUTPUT_DATA_DIR"</span><span class="p">))</span>

    <span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"command line arguments: "</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="n">estimators</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">estimators</span>
    <span class="n">sm_model_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_model_dir</span>
    <span class="n">training_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_channel_train</span>
    <span class="n">testing_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_channel_test</span>
    <span class="n">output_data_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_output_data_dir</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"training_dir: </span><span class="si">{</span><span class="n">training_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"training_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">training_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>  
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"testing_dir: </span><span class="si">{</span><span class="n">testing_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"testing_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">testing_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sm_model_dir: </span><span class="si">{</span><span class="n">sm_model_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"output_data_dir: </span><span class="si">{</span><span class="n">output_data_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Read in data</span>
    <span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">training_dir</span> <span class="o">+</span> <span class="s2">"/train.csv"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">testing_dir</span> <span class="o">+</span> <span class="s2">"/test.csv"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>

    <span class="c1"># Preprocess data</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"class_cat"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">"class_cat"</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"class_cat"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">"class_cat"</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"X_train.shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y_train.shape: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"X_train.shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y_train.shape: </span><span class="si">{</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Build model</span>
    <span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">)</span>
    <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Save the model</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">regressor</span><span class="p">,</span> <span class="n">sm_model_dir</span> <span class="o">+</span> <span class="s2">"/model.joblib"</span><span class="p">)</span>

    <span class="c1"># Save the results</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_data_dir</span> <span class="o">+</span> <span class="s2">"/y_pred.csv"</span><span class="p">)</span>

    <span class="c1"># save the confusion matrix</span>
    <span class="n">cf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">save_confusion_matrix</span><span class="p">(</span><span class="n">cf_matrix</span><span class="p">,</span> <span class="n">output_data_dir</span><span class="p">)</span>

    <span class="c1"># print sm_model_dir info</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sm_model_dir: </span><span class="si">{</span><span class="n">sm_model_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sm_model_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">sm_model_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># print output_data_dir info</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"output_data_dir: </span><span class="si">{</span><span class="n">output_data_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"output_data_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_data_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting ./datasets/2022-07-07-sagemaker-script-mode/src/train_and_serve.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, all the ingredients are ready. Let's run our script from the SKLean container.</p>
<p>In the next cell, you can see that we have passed two extra parameters to the estimator.</p>
<ul>
<li>
<strong>source_dir</strong> this path points to the directory with the <strong>entry_point</strong> script <code>train_and_serve.py</code> and <code>requirements.txt</code>. If any <code>requirements.txt</code> file is in this directory, the estimator will pick that and install those packages in the container during initialization.</li>
<li>
<strong>dependencies</strong> this points to a list of dependencies (custom libraries) that we want available in the container.</li>
</ul>
<p>Our local directory structure is shown below.</p>

<pre><code>local_path/
├── my_custom_library/
│   ├── seaborn_confusion_matrix.py
│   └── __init__.py
└── src/
    ├── train_and_serve.py
    └── requirements.txt</code></pre>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="n">script_file_name</span><span class="p">,</span>
    <span class="n">source_dir</span><span class="o">=</span><span class="n">script_path</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">custom_library_path</span><span class="p">],</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'local'</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"1.0-1"</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span><span class="s2">"estimators"</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">sk_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">({</span><span class="s2">"train"</span><span class="p">:</span> <span class="n">s3_train_uri</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">:</span> <span class="n">s3_test_uri</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating xm0kutxos7-algo-1-8yrs9 ... 
Creating xm0kutxos7-algo-1-8yrs9 ... done
Attaching to xm0kutxos7-algo-1-8yrs9
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 2022-07-17 15:24:24,458 sagemaker-containers INFO     Imported framework sagemaker_sklearn_container.training
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 2022-07-17 15:24:24,462 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 2022-07-17 15:24:24,472 sagemaker_sklearn_container.training INFO     Invoking user training script.
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 2022-07-17 15:24:24,661 sagemaker-training-toolkit INFO     Installing dependencies from requirements.txt:
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> /miniconda3/bin/python -m pip install -r requirements.txt
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Collecting seaborn==0.11.2
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>   Downloading seaborn-0.11.2-py3-none-any.whl (292 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">292.8/292.8 kB</span> <span class="ansi-red-fg">5.1 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:01eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Requirement already satisfied: pandas&gt;=0.23 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.1.3)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Collecting matplotlib&gt;=2.2
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>   Downloading matplotlib-3.5.2-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (11.3 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">11.3/11.3 MB</span> <span class="ansi-red-fg">31.0 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:0100:01:--:--
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Requirement already satisfied: numpy&gt;=1.15 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.21.0)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Requirement already satisfied: scipy&gt;=1.0 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.5.3)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Collecting kiwisolver&gt;=1.0.1
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>   Downloading kiwisolver-1.4.4-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (1.2 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">1.2/1.2 MB</span> <span class="ansi-red-fg">18.6 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>:00:01ta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Collecting cycler&gt;=0.10
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>   Downloading cycler-0.11.0-py3-none-any.whl (6.4 kB)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Collecting fonttools&gt;=4.22.0
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>   Downloading fonttools-4.34.4-py3-none-any.whl (944 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">944.1/944.1 kB</span> <span class="ansi-red-fg">102.1 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>31m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Collecting packaging&gt;=20.0
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>   Downloading packaging-21.3-py3-none-any.whl (40 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">40.8/40.8 kB</span> <span class="ansi-red-fg">11.9 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>1m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Requirement already satisfied: pillow&gt;=6.2.0 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (9.1.1)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Collecting pyparsing&gt;=2.2.1
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>   Downloading pyparsing-3.0.9-py3-none-any.whl (98 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">98.3/98.3 kB</span> <span class="ansi-red-fg">24.8 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>1m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Requirement already satisfied: python-dateutil&gt;=2.7 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2.8.1)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Requirement already satisfied: pytz&gt;=2017.2 in /miniconda3/lib/python3.8/site-packages (from pandas&gt;=0.23-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2022.1)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Requirement already satisfied: six&gt;=1.5 in /miniconda3/lib/python3.8/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.15.0)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Installing collected packages: pyparsing, kiwisolver, fonttools, cycler, packaging, matplotlib, seaborn
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Successfully installed cycler-0.11.0 fonttools-4.34.4 kiwisolver-1.4.4 matplotlib-3.5.2 packaging-21.3 pyparsing-3.0.9 seaborn-0.11.2
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> <span class="ansi-yellow-fg">WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</span><span class="ansi-yellow-fg">
</span><span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 2022-07-17 15:24:30,839 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 2022-07-17 15:24:30,859 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 2022-07-17 15:24:30,879 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 2022-07-17 15:24:30,894 sagemaker-training-toolkit INFO     Invoking user script
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Training Env:
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> {
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "additional_framework_parameters": {},
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "channel_input_dirs": {
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         "train": "/opt/ml/input/data/train",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         "test": "/opt/ml/input/data/test"
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     },
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "current_host": "algo-1-8yrs9",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "framework_module": "sagemaker_sklearn_container.training:main",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "hosts": [
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         "algo-1-8yrs9"
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     ],
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "hyperparameters": {
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         "estimators": 10
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     },
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "input_config_dir": "/opt/ml/input/config",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "input_data_config": {
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         "train": {
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         },
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         "test": {
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         }
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     },
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "input_dir": "/opt/ml/input",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "is_master": true,
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "job_name": "sagemaker-scikit-learn-2022-07-17-15-24-22-270",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "log_level": 20,
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "master_hostname": "algo-1-8yrs9",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "model_dir": "/opt/ml/model",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "module_dir": "s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-24-22-270/source/sourcedir.tar.gz",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "module_name": "train_and_serve",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "network_interface_name": "eth0",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "num_cpus": 2,
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "num_gpus": 0,
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "output_data_dir": "/opt/ml/output/data",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "output_dir": "/opt/ml/output",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "output_intermediate_dir": "/opt/ml/output/intermediate",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "resource_config": {
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         "current_host": "algo-1-8yrs9",
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         "hosts": [
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>             "algo-1-8yrs9"
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>         ]
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     },
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span>     "user_entry_point": "train_and_serve.py"
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> }
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Environment variables:
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_HOSTS=["algo-1-8yrs9"]
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_NETWORK_INTERFACE_NAME=eth0
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_HPS={"estimators":10}
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_USER_ENTRY_POINT=train_and_serve.py
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_FRAMEWORK_PARAMS={}
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_RESOURCE_CONFIG={"current_host":"algo-1-8yrs9","hosts":["algo-1-8yrs9"]}
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_INPUT_DATA_CONFIG={"test":{"TrainingInputMode":"File"},"train":{"TrainingInputMode":"File"}}
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_OUTPUT_DATA_DIR=/opt/ml/output/data
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_CHANNELS=["test","train"]
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_CURRENT_HOST=algo-1-8yrs9
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_MODULE_NAME=train_and_serve
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_LOG_LEVEL=20
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_FRAMEWORK_MODULE=sagemaker_sklearn_container.training:main
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_INPUT_DIR=/opt/ml/input
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_INPUT_CONFIG_DIR=/opt/ml/input/config
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_OUTPUT_DIR=/opt/ml/output
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_NUM_CPUS=2
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_NUM_GPUS=0
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_MODEL_DIR=/opt/ml/model
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-24-22-270/source/sourcedir.tar.gz
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{"test":"/opt/ml/input/data/test","train":"/opt/ml/input/data/train"},"current_host":"algo-1-8yrs9","framework_module":"sagemaker_sklearn_container.training:main","hosts":["algo-1-8yrs9"],"hyperparameters":{"estimators":10},"input_config_dir":"/opt/ml/input/config","input_data_config":{"test":{"TrainingInputMode":"File"},"train":{"TrainingInputMode":"File"}},"input_dir":"/opt/ml/input","is_master":true,"job_name":"sagemaker-scikit-learn-2022-07-17-15-24-22-270","log_level":20,"master_hostname":"algo-1-8yrs9","model_dir":"/opt/ml/model","module_dir":"s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-24-22-270/source/sourcedir.tar.gz","module_name":"train_and_serve","network_interface_name":"eth0","num_cpus":2,"num_gpus":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_host":"algo-1-8yrs9","hosts":["algo-1-8yrs9"]},"user_entry_point":"train_and_serve.py"}
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_USER_ARGS=["--estimators","10"]
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_CHANNEL_TRAIN=/opt/ml/input/data/train
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_CHANNEL_TEST=/opt/ml/input/data/test
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> SM_HP_ESTIMATORS=10
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> PYTHONPATH=/opt/ml/code:/miniconda3/bin:/miniconda3/lib/python38.zip:/miniconda3/lib/python3.8:/miniconda3/lib/python3.8/lib-dynload:/miniconda3/lib/python3.8/site-packages
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> Invoking script with the following command:
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> /miniconda3/bin/python train_and_serve.py --estimators 10
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> command line arguments:  Namespace(estimators=10, sm_channel_test='/opt/ml/input/data/test', sm_channel_train='/opt/ml/input/data/train', sm_model_dir='/opt/ml/model', sm_output_data_dir='/opt/ml/output/data')
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> training_dir: /opt/ml/input/data/train
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> training_dir files list: ['train.csv']
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> testing_dir: /opt/ml/input/data/test
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> testing_dir files list: ['test.csv']
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> sm_model_dir: /opt/ml/model
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> output_data_dir: /opt/ml/output/data
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> X_train.shape: (120, 4)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> y_train.shape: (120,)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> X_train.shape: (30, 4)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> y_train.shape: (30,)
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> sm_model_dir: /opt/ml/model
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> sm_model_dir files list: ['model.joblib']
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> output_data_dir: /opt/ml/output/data
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> output_data_dir files list: ['y_pred.csv', 'output_cm.png']
<span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 |</span> 2022-07-17 15:24:33,003 sagemaker-containers INFO     Reporting training SUCCESS
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Failed to delete: /tmp/tmpee3z9n_9/algo-1-8yrs9 Please remove it manually.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-cyan-fg">xm0kutxos7-algo-1-8yrs9 exited with code 0
</span>Aborting on container exit...
===== Job Complete =====
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/myblog/images/copied_from_nb/images/2022-07-07-sagemaker-script-mode/sklearn-output-train-complete.png" alt="sklearn-output-train-complete"></p>
<p>SKLearn container output shows that our classifier is successfully trained, and the model and output artifacts are placed in their respective folders. We know from the first section of this post that these artifacts will automatically be uploaded to the S3 bucket. This concludes the model training part of our implementation. Let's now proceed to model serving part of our solution.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Serve-SKLearn-model-in-local-mode">
<a class="anchor" href="#Serve-SKLearn-model-in-local-mode" aria-hidden="true"><span class="octicon octicon-link"></span></a>Serve SKLearn model in local mode<a class="anchor-link" href="#Serve-SKLearn-model-in-local-mode"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At this point, we have our trained model ready. Can we deploy it already?</p>
<p>The answer is no. If we try to deploy this model using command</p>

<pre><code>sk_predictor = sk_estimator.deploy(
    initial_instance_count=1,
    instance_type='local'
)</code></pre>
<p>It will generate an exception message telling us that the estimator does not know how to load the model. So we need to tell the estimator by implementing <code>model_fn</code> function in our script.</p>

<pre><code>[2022-07-09 06:15:45 +0000] [31] [ERROR] Error handling request /ping
Traceback (most recent call last):
  File "/miniconda3/lib/python3.8/site-packages/sagemaker_containers/_functions.py", line 93, in wrapper
    return fn(*args, **kwargs)
  File "/miniconda3/lib/python3.8/site-packages/sagemaker_sklearn_container/serving.py", line 43, in default_model_fn
    return transformer.default_model_fn(model_dir)
  File "/miniconda3/lib/python3.8/site-packages/sagemaker_containers/_transformer.py", line 35, in default_model_fn
    raise NotImplementedError(
NotImplementedError: 
Please provide a model_fn implementation.
See documentation for model_fn at https://github.com/aws/sagemaker-python-sdk</code></pre>
<p>The <em>model_fn</em> has the following signature:</p>

<pre><code>def model_fn(model_dir)</code></pre>
<p>Besides loading the model, we also need to tell the model server how to get predictions from the loaded model. For this, we need to implement the second function <em>predict_fn</em>, which has the following signature.</p>

<pre><code>def predict_fn(input_data, model)</code></pre>
<p>After we have called the <code>fit</code> function on our SKLearn estimator, we can deploy it by calling the <code>deploy</code> function to create an inference endpoint. Once you call <code>deploy</code> on the estimator two objects are created in response</p>
<ul>
<li>SageMaker scikit-learn Endpoint: This Endpoint encapsulates a model server running under it. The model server will load the model saved during training and perform inference on it. It requires two helper functions to load the model and make inferences on it: model_fn and predict_fn.</li>
<li>Predictor object: This object is returned in response to the deploy call. It can be used to do inference on the Endpoint hosting our SKLearn model.</li>
</ul>
<p>Let's update our script and add these two functions.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> $script_file

<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="kn">from</span> <span class="nn">my_custom_library</span> <span class="kn">import</span> <span class="n">save_confusion_matrix</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>

    <span class="c1"># Pass in environment variables and hyperparameters</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="c1"># Hyperparameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--estimators"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="c1"># sm_model_dir: model artifacts stored here after training</span>
    <span class="c1"># sm-channel-train: input training data location</span>
    <span class="c1"># sm-channel-test: input test data location</span>
    <span class="c1"># sm-output-data-dir: output artifacts location</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-model-dir"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_MODEL_DIR"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-channel-train"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_CHANNEL_TRAIN"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-channel-test"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_CHANNEL_TEST"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-output-data-dir"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_OUTPUT_DATA_DIR"</span><span class="p">))</span>

    <span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"command line arguments: "</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="n">estimators</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">estimators</span>
    <span class="n">sm_model_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_model_dir</span>
    <span class="n">training_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_channel_train</span>
    <span class="n">testing_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_channel_test</span>
    <span class="n">output_data_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_output_data_dir</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"training_dir: </span><span class="si">{</span><span class="n">training_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"training_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">training_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>  
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"testing_dir: </span><span class="si">{</span><span class="n">testing_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"testing_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">testing_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sm_model_dir: </span><span class="si">{</span><span class="n">sm_model_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"output_data_dir: </span><span class="si">{</span><span class="n">output_data_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Read in data</span>
    <span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">training_dir</span> <span class="o">+</span> <span class="s2">"/train.csv"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">testing_dir</span> <span class="o">+</span> <span class="s2">"/test.csv"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>

    <span class="c1"># Preprocess data</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"class_cat"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">"class_cat"</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"class_cat"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">"class_cat"</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"X_train.shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y_train.shape: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"X_train.shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y_train.shape: </span><span class="si">{</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Build model</span>
    <span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">)</span>
    <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Save the model</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">regressor</span><span class="p">,</span> <span class="n">sm_model_dir</span> <span class="o">+</span> <span class="s2">"/model.joblib"</span><span class="p">)</span>

    <span class="c1"># Save the results</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_data_dir</span> <span class="o">+</span> <span class="s2">"/y_pred.csv"</span><span class="p">)</span>

    <span class="c1"># save the confusion matrix</span>
    <span class="n">cf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">save_confusion_matrix</span><span class="p">(</span><span class="n">cf_matrix</span><span class="p">,</span> <span class="n">output_data_dir</span><span class="p">)</span>

    <span class="c1"># print sm_model_dir info</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sm_model_dir: </span><span class="si">{</span><span class="n">sm_model_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sm_model_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">sm_model_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># print output_data_dir info</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"output_data_dir: </span><span class="si">{</span><span class="n">output_data_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"output_data_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_data_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="c1"># Model serving</span>
<span class="sd">"""</span>
<span class="sd">Deserialize fitted model</span>
<span class="sd">"""</span>
<span class="k">def</span> <span class="nf">model_fn</span><span class="p">(</span><span class="n">model_dir</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"model_fn model_dir: </span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s2">"model.joblib"</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="sd">"""</span>
<span class="sd">predict_fn</span>
<span class="sd">    input_data: returned array from input_fn above</span>
<span class="sd">    model (sklearn model) returned model loaded from model_fn above</span>
<span class="sd">"""</span>
<span class="k">def</span> <span class="nf">predict_fn</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting ./datasets/2022-07-07-sagemaker-script-mode/src/train_and_serve.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="n">script_file_name</span><span class="p">,</span>
    <span class="n">source_dir</span><span class="o">=</span><span class="n">script_path</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">custom_library_path</span><span class="p">],</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'local'</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"1.0-1"</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span><span class="s2">"estimators"</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">sk_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">({</span><span class="s2">"train"</span><span class="p">:</span> <span class="n">s3_train_uri</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">:</span> <span class="n">s3_test_uri</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating wxtcttdsw0-algo-1-jym48 ... 
Creating wxtcttdsw0-algo-1-jym48 ... done
Attaching to wxtcttdsw0-algo-1-jym48
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 2022-07-17 15:24:36,721 sagemaker-containers INFO     Imported framework sagemaker_sklearn_container.training
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 2022-07-17 15:24:36,726 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 2022-07-17 15:24:36,735 sagemaker_sklearn_container.training INFO     Invoking user training script.
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 2022-07-17 15:24:36,923 sagemaker-training-toolkit INFO     Installing dependencies from requirements.txt:
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> /miniconda3/bin/python -m pip install -r requirements.txt
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Collecting seaborn==0.11.2
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>   Downloading seaborn-0.11.2-py3-none-any.whl (292 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">292.8/292.8 kB</span> <span class="ansi-red-fg">3.3 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:01eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Requirement already satisfied: pandas&gt;=0.23 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.1.3)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Collecting matplotlib&gt;=2.2
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>   Downloading matplotlib-3.5.2-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (11.3 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">11.3/11.3 MB</span> <span class="ansi-red-fg">101.6 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:0100:01:--:--
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Requirement already satisfied: numpy&gt;=1.15 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.21.0)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Requirement already satisfied: scipy&gt;=1.0 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.5.3)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Collecting packaging&gt;=20.0
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>   Downloading packaging-21.3-py3-none-any.whl (40 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">40.8/40.8 kB</span> <span class="ansi-red-fg">12.9 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>1m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Requirement already satisfied: pillow&gt;=6.2.0 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (9.1.1)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Collecting cycler&gt;=0.10
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>   Downloading cycler-0.11.0-py3-none-any.whl (6.4 kB)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Collecting kiwisolver&gt;=1.0.1
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>   Downloading kiwisolver-1.4.4-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (1.2 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">1.2/1.2 MB</span> <span class="ansi-red-fg">86.1 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>31m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Requirement already satisfied: python-dateutil&gt;=2.7 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2.8.1)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Collecting fonttools&gt;=4.22.0
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>   Downloading fonttools-4.34.4-py3-none-any.whl (944 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">944.1/944.1 kB</span> <span class="ansi-red-fg">8.7 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:01eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Collecting pyparsing&gt;=2.2.1
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>   Downloading pyparsing-3.0.9-py3-none-any.whl (98 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">98.3/98.3 kB</span> <span class="ansi-red-fg">27.8 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>1m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Requirement already satisfied: pytz&gt;=2017.2 in /miniconda3/lib/python3.8/site-packages (from pandas&gt;=0.23-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2022.1)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Requirement already satisfied: six&gt;=1.5 in /miniconda3/lib/python3.8/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.15.0)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Installing collected packages: pyparsing, kiwisolver, fonttools, cycler, packaging, matplotlib, seaborn
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Successfully installed cycler-0.11.0 fonttools-4.34.4 kiwisolver-1.4.4 matplotlib-3.5.2 packaging-21.3 pyparsing-3.0.9 seaborn-0.11.2
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> <span class="ansi-yellow-fg">WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</span><span class="ansi-yellow-fg">
</span><span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 2022-07-17 15:24:41,696 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 2022-07-17 15:24:41,711 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 2022-07-17 15:24:41,723 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 2022-07-17 15:24:41,732 sagemaker-training-toolkit INFO     Invoking user script
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Training Env:
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> {
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "additional_framework_parameters": {},
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "channel_input_dirs": {
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         "train": "/opt/ml/input/data/train",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         "test": "/opt/ml/input/data/test"
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     },
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "current_host": "algo-1-jym48",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "framework_module": "sagemaker_sklearn_container.training:main",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "hosts": [
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         "algo-1-jym48"
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     ],
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "hyperparameters": {
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         "estimators": 10
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     },
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "input_config_dir": "/opt/ml/input/config",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "input_data_config": {
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         "train": {
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         },
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         "test": {
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         }
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     },
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "input_dir": "/opt/ml/input",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "is_master": true,
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "job_name": "sagemaker-scikit-learn-2022-07-17-15-24-34-114",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "log_level": 20,
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "master_hostname": "algo-1-jym48",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "model_dir": "/opt/ml/model",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "module_dir": "s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-24-34-114/source/sourcedir.tar.gz",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "module_name": "train_and_serve",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "network_interface_name": "eth0",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "num_cpus": 2,
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "num_gpus": 0,
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "output_data_dir": "/opt/ml/output/data",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "output_dir": "/opt/ml/output",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "output_intermediate_dir": "/opt/ml/output/intermediate",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "resource_config": {
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         "current_host": "algo-1-jym48",
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         "hosts": [
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>             "algo-1-jym48"
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>         ]
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     },
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span>     "user_entry_point": "train_and_serve.py"
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> }
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Environment variables:
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_HOSTS=["algo-1-jym48"]
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_NETWORK_INTERFACE_NAME=eth0
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_HPS={"estimators":10}
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_USER_ENTRY_POINT=train_and_serve.py
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_FRAMEWORK_PARAMS={}
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_RESOURCE_CONFIG={"current_host":"algo-1-jym48","hosts":["algo-1-jym48"]}
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_INPUT_DATA_CONFIG={"test":{"TrainingInputMode":"File"},"train":{"TrainingInputMode":"File"}}
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_OUTPUT_DATA_DIR=/opt/ml/output/data
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_CHANNELS=["test","train"]
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_CURRENT_HOST=algo-1-jym48
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_MODULE_NAME=train_and_serve
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_LOG_LEVEL=20
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_FRAMEWORK_MODULE=sagemaker_sklearn_container.training:main
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_INPUT_DIR=/opt/ml/input
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_INPUT_CONFIG_DIR=/opt/ml/input/config
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_OUTPUT_DIR=/opt/ml/output
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_NUM_CPUS=2
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_NUM_GPUS=0
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_MODEL_DIR=/opt/ml/model
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-24-34-114/source/sourcedir.tar.gz
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{"test":"/opt/ml/input/data/test","train":"/opt/ml/input/data/train"},"current_host":"algo-1-jym48","framework_module":"sagemaker_sklearn_container.training:main","hosts":["algo-1-jym48"],"hyperparameters":{"estimators":10},"input_config_dir":"/opt/ml/input/config","input_data_config":{"test":{"TrainingInputMode":"File"},"train":{"TrainingInputMode":"File"}},"input_dir":"/opt/ml/input","is_master":true,"job_name":"sagemaker-scikit-learn-2022-07-17-15-24-34-114","log_level":20,"master_hostname":"algo-1-jym48","model_dir":"/opt/ml/model","module_dir":"s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-24-34-114/source/sourcedir.tar.gz","module_name":"train_and_serve","network_interface_name":"eth0","num_cpus":2,"num_gpus":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_host":"algo-1-jym48","hosts":["algo-1-jym48"]},"user_entry_point":"train_and_serve.py"}
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_USER_ARGS=["--estimators","10"]
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_CHANNEL_TRAIN=/opt/ml/input/data/train
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_CHANNEL_TEST=/opt/ml/input/data/test
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> SM_HP_ESTIMATORS=10
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> PYTHONPATH=/opt/ml/code:/miniconda3/bin:/miniconda3/lib/python38.zip:/miniconda3/lib/python3.8:/miniconda3/lib/python3.8/lib-dynload:/miniconda3/lib/python3.8/site-packages
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> Invoking script with the following command:
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> /miniconda3/bin/python train_and_serve.py --estimators 10
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> command line arguments:  Namespace(estimators=10, sm_channel_test='/opt/ml/input/data/test', sm_channel_train='/opt/ml/input/data/train', sm_model_dir='/opt/ml/model', sm_output_data_dir='/opt/ml/output/data')
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> training_dir: /opt/ml/input/data/train
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> training_dir files list: ['train.csv']
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> testing_dir: /opt/ml/input/data/test
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> testing_dir files list: ['test.csv']
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> sm_model_dir: /opt/ml/model
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> output_data_dir: /opt/ml/output/data
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> X_train.shape: (120, 4)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> y_train.shape: (120,)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> X_train.shape: (30, 4)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> y_train.shape: (30,)
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> sm_model_dir: /opt/ml/model
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> sm_model_dir files list: ['model.joblib']
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> output_data_dir: /opt/ml/output/data
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> output_data_dir files list: ['y_pred.csv', 'output_cm.png']
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 |</span> 2022-07-17 15:24:43,775 sagemaker-containers INFO     Reporting training SUCCESS
<span class="ansi-cyan-fg">wxtcttdsw0-algo-1-jym48 exited with code 0
</span>Aborting on container exit...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Failed to delete: /tmp/tmpa3uld7ha/algo-1-jym48 Please remove it manually.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>===== Job Complete =====
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our model is trained. Let's also deploy it in the local model. For model loading <code>model_fn</code>, SageMaker will download the model artifacts from S3 and mount them on <code>/opt/ml/model</code>. This way, our script can load the model from within the container.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_predictor</span> <span class="o">=</span> <span class="n">sk_estimator</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span>
    <span class="n">initial_instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'local'</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Attaching to 3fvyanwal0-algo-1-tz4ow
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022-07-17 15:24:46,644 INFO - sagemaker-containers - No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022-07-17 15:24:46,648 INFO - sagemaker-containers - No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022-07-17 15:24:46,649 INFO - sagemaker-containers - nginx config: 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> worker_processes auto;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> daemon off;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> pid /tmp/nginx.pid;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> error_log  /dev/stderr;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> worker_rlimit_nofile 4096;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> events {
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   worker_connections 2048;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> }
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> http {
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   include /etc/nginx/mime.types;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   default_type application/octet-stream;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   access_log /dev/stdout combined;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   upstream gunicorn {
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>     server unix:/tmp/gunicorn.sock;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   }
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   server {
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>     listen 8080 deferred;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>     client_max_body_size 0;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>     keepalive_timeout 3;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>     location ~ ^/(ping|invocations|execution-parameters) {
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>       proxy_set_header Host $http_host;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>       proxy_redirect off;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>       proxy_read_timeout 60s;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>       proxy_pass http://gunicorn;
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>     }
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>     location / {
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>       return 404 "{}";
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>     }
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   }
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> }
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022-07-17 15:24:46,866 INFO - sagemaker-containers - Module train_and_serve does not provide a setup.py. 
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Generating setup.py
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022-07-17 15:24:46,866 INFO - sagemaker-containers - Generating setup.cfg
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022-07-17 15:24:46,866 INFO - sagemaker-containers - Generating MANIFEST.in
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022-07-17 15:24:46,867 INFO - sagemaker-containers - Installing module with the following command:
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> /miniconda3/bin/python3 -m pip install . -r requirements.txt
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Processing /opt/ml/code
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Preparing metadata (setup.py) ... done
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Collecting seaborn==0.11.2
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Downloading seaborn-0.11.2-py3-none-any.whl (292 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">292.8/292.8 kB</span> <span class="ansi-red-fg">4.8 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:01eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Collecting matplotlib&gt;=2.2
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Downloading matplotlib-3.5.2-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (11.3 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">11.3/11.3 MB</span> <span class="ansi-red-fg">93.0 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:0100:01:--:--
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Requirement already satisfied: scipy&gt;=1.0 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.5.3)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Requirement already satisfied: numpy&gt;=1.15 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.21.0)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Requirement already satisfied: pandas&gt;=0.23 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.1.3)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Requirement already satisfied: pillow&gt;=6.2.0 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (9.1.1)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Collecting packaging&gt;=20.0
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Downloading packaging-21.3-py3-none-any.whl (40 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">40.8/40.8 kB</span> <span class="ansi-red-fg">9.1 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>31m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Collecting fonttools&gt;=4.22.0
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Downloading fonttools-4.34.4-py3-none-any.whl (944 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">944.1/944.1 kB</span> <span class="ansi-red-fg">8.1 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:01eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Requirement already satisfied: python-dateutil&gt;=2.7 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2.8.1)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Collecting cycler&gt;=0.10
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Downloading cycler-0.11.0-py3-none-any.whl (6.4 kB)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Collecting pyparsing&gt;=2.2.1
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Downloading pyparsing-3.0.9-py3-none-any.whl (98 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">98.3/98.3 kB</span> <span class="ansi-red-fg">21.4 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>1m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Collecting kiwisolver&gt;=1.0.1
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Downloading kiwisolver-1.4.4-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (1.2 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">1.2/1.2 MB</span> <span class="ansi-red-fg">17.1 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>:00:01ta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Requirement already satisfied: pytz&gt;=2017.2 in /miniconda3/lib/python3.8/site-packages (from pandas&gt;=0.23-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2022.1)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Requirement already satisfied: six&gt;=1.5 in /miniconda3/lib/python3.8/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.15.0)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Building wheels for collected packages: train-and-serve
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Building wheel for train-and-serve (setup.py) ... 2022/07/17 15:24:49 [crit] 15#15: *1 connect() to unix:/tmp/gunicorn.sock failed (2: No such file or directory) while connecting to upstream, client: 172.18.0.1, server: , request: "GET /ping HTTP/1.1", upstream: "http://unix:/tmp/gunicorn.sock:/ping", host: "localhost:8080"
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 172.18.0.1 - - [17/Jul/2022:15:24:49 +0000] "GET /ping HTTP/1.1" 502 182 "-" "python-urllib3/1.26.8"
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> done
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Created wheel for train-and-serve: filename=train_and_serve-1.0.0-py2.py3-none-any.whl size=6122 sha256=914e6ad8ea2651da0216fefbc30c28bc25124ff514c30452de608e5b9807197c
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span>   Stored in directory: /home/model-server/tmp/pip-ephem-wheel-cache-2u_4hcln/wheels/f3/75/57/158162e9eab7af12b5c338c279b3a81f103b89d74eeb911c00
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Successfully built train-and-serve
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Installing collected packages: train-and-serve, pyparsing, kiwisolver, fonttools, cycler, packaging, matplotlib, seaborn
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> Successfully installed cycler-0.11.0 fonttools-4.34.4 kiwisolver-1.4.4 matplotlib-3.5.2 packaging-21.3 pyparsing-3.0.9 seaborn-0.11.2 train-and-serve-1.0.0
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> <span class="ansi-yellow-fg">WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</span><span class="ansi-yellow-fg">
</span><span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022/07/17 15:24:54 [crit] 15#15: *3 connect() to unix:/tmp/gunicorn.sock failed (2: No such file or directory) while connecting to upstream, client: 172.18.0.1, server: , request: "GET /ping HTTP/1.1", upstream: "http://unix:/tmp/gunicorn.sock:/ping", host: "localhost:8080"
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 172.18.0.1 - - [17/Jul/2022:15:24:54 +0000] "GET /ping HTTP/1.1" 502 182 "-" "python-urllib3/1.26.8"
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022-07-17 15:24:55,286 INFO - matplotlib.font_manager - generated new fontManager
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> [2022-07-17 15:24:55 +0000] [37] [INFO] Starting gunicorn 20.0.4
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> [2022-07-17 15:24:55 +0000] [37] [INFO] Listening at: unix:/tmp/gunicorn.sock (37)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> [2022-07-17 15:24:55 +0000] [37] [INFO] Using worker: gevent
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> [2022-07-17 15:24:55 +0000] [39] [INFO] Booting worker with pid: 39
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> [2022-07-17 15:24:56 +0000] [40] [INFO] Booting worker with pid: 40
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022-07-17 15:24:59,750 INFO - sagemaker-containers - No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> model_fn model_dir: /opt/ml/model
!<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 172.18.0.1 - - [17/Jul/2022:15:25:01 +0000] "GET /ping HTTP/1.1" 200 0 "-" "python-urllib3/1.26.8"
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's create a sample request and get a prediction from our local inference endpoint.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">request</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">9.0</span><span class="p">,</span> <span class="mi">3571</span><span class="p">,</span> <span class="mi">1976</span><span class="p">,</span> <span class="mf">0.525</span><span class="p">]]</span>

<span class="n">response</span>  <span class="o">=</span> <span class="n">sk_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">response</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 2022-07-17 15:25:01,760 INFO - sagemaker-containers - No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> model_fn model_dir: /opt/ml/model
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>2</pre>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-cyan-fg">3fvyanwal0-algo-1-tz4ow |</span> 172.18.0.1 - - [17/Jul/2022:15:25:03 +0000] "POST /invocations HTTP/1.1" 200 136 "-" "python-urllib3/1.26.8"
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># map response to correct category type</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Predicted class category </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">categories_map</span><span class="p">[</span><span class="n">response</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Predicted class category 2 (Iris-virginica)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since the enpoint in running in the local environment we can observe a webserver running in a docker instance.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>docker ps
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CONTAINER ID   IMAGE                                                                               COMMAND   CREATED          STATUS          PORTS                                       NAMES
5a22263f860b   683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:1.0-1-cpu-py3   "serve"   18 seconds ago   Up 17 seconds   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp   3fvyanwal0-algo-1-tz4ow
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># delete the local endpoint</span>
<span class="n">sk_predictor</span><span class="o">.</span><span class="n">delete_endpoint</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Gracefully stopping... (press Ctrl+C again to force)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that in local mode, we can only serve a single model simultaneously. Therefore, if you are getting an error on the <code>deploy</code> call in the local model, then check that there is no other endpoint running.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="SKLean-model-server-input-and-output-processing">
<a class="anchor" href="#SKLean-model-server-input-and-output-processing" aria-hidden="true"><span class="octicon octicon-link"></span></a>SKLean model server input and output processing<a class="anchor-link" href="#SKLean-model-server-input-and-output-processing"> </a>
</h1>
<p>SageMaker model server breaks the incoming request into three steps:</p>
<ol>
<li>input processing</li>
<li>prediction, and</li>
<li>output processing</li>
</ol>
<p>In the last section, we have seen that the <code>predict_fn</code> function in the source code file defines model prediction. Similarly, SageMaker provides two additional functions to control input and output processing, defined as <code>input_fn</code> and <code>output_fn</code>, respectively. Both these function have their default implementations. But we can override them by providing our own implementation for them in the source script. If no definition is provided in the source script, then the SageMaker scikit-learn model server will use the default implementation.</p>
<ul>
<li>
<strong><code>input_fn</code></strong>: Takes request data and deserializes the data into an object for prediction.</li>
<li>
<strong><code>output_fn</code></strong>: Takes the prediction result and serializes this according to the response content type.</li>
</ul>
<p>Let's update our script to preprocess input request and output response as JSON objects.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> $script_file

<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">my_custom_library</span> <span class="kn">import</span> <span class="n">save_confusion_matrix</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>

    <span class="c1"># Pass in environment variables and hyperparameters</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="c1"># Hyperparameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--estimators"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="c1"># sm_model_dir: model artifacts stored here after training</span>
    <span class="c1"># sm-channel-train: input training data location</span>
    <span class="c1"># sm-channel-test: input test data location</span>
    <span class="c1"># sm-output-data-dir: output artifacts location</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-model-dir"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_MODEL_DIR"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-channel-train"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_CHANNEL_TRAIN"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-channel-test"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_CHANNEL_TEST"</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--sm-output-data-dir"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SM_OUTPUT_DATA_DIR"</span><span class="p">))</span>

    <span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"command line arguments: "</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="n">estimators</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">estimators</span>
    <span class="n">sm_model_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_model_dir</span>
    <span class="n">training_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_channel_train</span>
    <span class="n">testing_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_channel_test</span>
    <span class="n">output_data_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sm_output_data_dir</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"training_dir: </span><span class="si">{</span><span class="n">training_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"training_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">training_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>  
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"testing_dir: </span><span class="si">{</span><span class="n">testing_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"testing_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">testing_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sm_model_dir: </span><span class="si">{</span><span class="n">sm_model_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"output_data_dir: </span><span class="si">{</span><span class="n">output_data_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Read in data</span>
    <span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">training_dir</span> <span class="o">+</span> <span class="s2">"/train.csv"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">testing_dir</span> <span class="o">+</span> <span class="s2">"/test.csv"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>

    <span class="c1"># Preprocess data</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"class_cat"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">"class_cat"</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"class_cat"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">"class_cat"</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"X_train.shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y_train.shape: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"X_train.shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y_train.shape: </span><span class="si">{</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Build model</span>
    <span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">)</span>
    <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Save the model</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">regressor</span><span class="p">,</span> <span class="n">sm_model_dir</span> <span class="o">+</span> <span class="s2">"/model.joblib"</span><span class="p">)</span>

    <span class="c1"># Save the results</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_data_dir</span> <span class="o">+</span> <span class="s2">"/y_pred.csv"</span><span class="p">)</span>

    <span class="c1"># save the confusion matrix</span>
    <span class="n">cf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">save_confusion_matrix</span><span class="p">(</span><span class="n">cf_matrix</span><span class="p">,</span> <span class="n">output_data_dir</span><span class="p">)</span>

    <span class="c1"># print sm_model_dir info</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sm_model_dir: </span><span class="si">{</span><span class="n">sm_model_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sm_model_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">sm_model_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># print output_data_dir info</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"output_data_dir: </span><span class="si">{</span><span class="n">output_data_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"output_data_dir files list: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_data_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
<span class="c1"># Model serving</span>
<span class="sd">"""</span>
<span class="sd">Deserialize fitted model</span>
<span class="sd">"""</span>
<span class="k">def</span> <span class="nf">model_fn</span><span class="p">(</span><span class="n">model_dir</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"model_fn model_dir: </span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s2">"model.joblib"</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="sd">"""</span>
<span class="sd">predict_fn</span>
<span class="sd">    input_data: returned array from input_fn above</span>
<span class="sd">    model (sklearn model) returned model loaded from model_fn above</span>
<span class="sd">"""</span>
<span class="k">def</span> <span class="nf">predict_fn</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">input_fn</span>
<span class="sd">    request_body: The body of the request sent to the model.</span>
<span class="sd">    request_content_type: (string) specifies the format/variable type of the request</span>
<span class="sd">"""</span>
<span class="k">def</span> <span class="nf">input_fn</span><span class="p">(</span><span class="n">request_body</span><span class="p">,</span> <span class="n">request_content_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request_content_type</span> <span class="o">==</span> <span class="s2">"application/json"</span><span class="p">:</span>
        <span class="n">request_body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request_body</span><span class="p">)</span>
        <span class="n">inpVar</span> <span class="o">=</span> <span class="n">request_body</span><span class="p">[</span><span class="s2">"Input"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">inpVar</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"This model only supports application/json input"</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">output_fn</span>
<span class="sd">    prediction: the returned value from predict_fn above</span>
<span class="sd">    content_type: the content type the endpoint expects to be returned. Ex: JSON, string</span>
<span class="sd">"""</span>
<span class="k">def</span> <span class="nf">output_fn</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">content_type</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">respJSON</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Output"</span><span class="p">:</span> <span class="n">res</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">respJSON</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Overwriting ./datasets/2022-07-07-sagemaker-script-mode/src/train_and_serve.py
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># train and deploy model with input and output as JSON objects</span>
<span class="n">sk_estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="n">script_file_name</span><span class="p">,</span>
    <span class="n">source_dir</span><span class="o">=</span><span class="n">script_path</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">custom_library_path</span><span class="p">],</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'local'</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"1.0-1"</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span><span class="s2">"estimators"</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">sk_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">({</span><span class="s2">"train"</span><span class="p">:</span> <span class="n">s3_train_uri</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">:</span> <span class="n">s3_test_uri</span><span class="p">})</span>

<span class="n">sk_predictor</span> <span class="o">=</span> <span class="n">sk_estimator</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span>
    <span class="n">initial_instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'local'</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Creating ubyi50juw8-algo-1-9w0jk ... 
Creating ubyi50juw8-algo-1-9w0jk ... done
Attaching to ubyi50juw8-algo-1-9w0jk
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 2022-07-17 15:25:07,036 sagemaker-containers INFO     Imported framework sagemaker_sklearn_container.training
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 2022-07-17 15:25:07,041 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 2022-07-17 15:25:07,050 sagemaker_sklearn_container.training INFO     Invoking user training script.
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 2022-07-17 15:25:07,233 sagemaker-training-toolkit INFO     Installing dependencies from requirements.txt:
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> /miniconda3/bin/python -m pip install -r requirements.txt
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Collecting seaborn==0.11.2
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>   Downloading seaborn-0.11.2-py3-none-any.whl (292 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">292.8/292.8 kB</span> <span class="ansi-red-fg">38.8 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>31m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Requirement already satisfied: scipy&gt;=1.0 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.5.3)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Collecting matplotlib&gt;=2.2
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>   Downloading matplotlib-3.5.2-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (11.3 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">11.3/11.3 MB</span> <span class="ansi-red-fg">94.9 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:0100:01:--:--
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Requirement already satisfied: pandas&gt;=0.23 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.1.3)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Requirement already satisfied: numpy&gt;=1.15 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.21.0)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Collecting pyparsing&gt;=2.2.1
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>   Downloading pyparsing-3.0.9-py3-none-any.whl (98 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">98.3/98.3 kB</span> <span class="ansi-red-fg">27.9 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>1m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Collecting cycler&gt;=0.10
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>   Downloading cycler-0.11.0-py3-none-any.whl (6.4 kB)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Collecting fonttools&gt;=4.22.0
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>   Downloading fonttools-4.34.4-py3-none-any.whl (944 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">944.1/944.1 kB</span> <span class="ansi-red-fg">26.2 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:01eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Collecting packaging&gt;=20.0
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>   Downloading packaging-21.3-py3-none-any.whl (40 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">40.8/40.8 kB</span> <span class="ansi-red-fg">3.6 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>31m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Requirement already satisfied: python-dateutil&gt;=2.7 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2.8.1)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Collecting kiwisolver&gt;=1.0.1
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>   Downloading kiwisolver-1.4.4-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (1.2 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">1.2/1.2 MB</span> <span class="ansi-red-fg">15.9 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>:00:01ta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Requirement already satisfied: pillow&gt;=6.2.0 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (9.1.1)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Requirement already satisfied: pytz&gt;=2017.2 in /miniconda3/lib/python3.8/site-packages (from pandas&gt;=0.23-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2022.1)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Requirement already satisfied: six&gt;=1.5 in /miniconda3/lib/python3.8/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.15.0)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Installing collected packages: pyparsing, kiwisolver, fonttools, cycler, packaging, matplotlib, seaborn
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Successfully installed cycler-0.11.0 fonttools-4.34.4 kiwisolver-1.4.4 matplotlib-3.5.2 packaging-21.3 pyparsing-3.0.9 seaborn-0.11.2
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> <span class="ansi-yellow-fg">WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</span><span class="ansi-yellow-fg">
</span><span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 2022-07-17 15:25:11,747 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 2022-07-17 15:25:11,760 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 2022-07-17 15:25:11,773 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 2022-07-17 15:25:11,781 sagemaker-training-toolkit INFO     Invoking user script
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Training Env:
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> {
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "additional_framework_parameters": {},
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "channel_input_dirs": {
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         "train": "/opt/ml/input/data/train",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         "test": "/opt/ml/input/data/test"
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     },
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "current_host": "algo-1-9w0jk",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "framework_module": "sagemaker_sklearn_container.training:main",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "hosts": [
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         "algo-1-9w0jk"
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     ],
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "hyperparameters": {
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         "estimators": 10
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     },
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "input_config_dir": "/opt/ml/input/config",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "input_data_config": {
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         "train": {
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         },
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         "test": {
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>             "TrainingInputMode": "File"
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         }
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     },
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "input_dir": "/opt/ml/input",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "is_master": true,
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "job_name": "sagemaker-scikit-learn-2022-07-17-15-25-04-516",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "log_level": 20,
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "master_hostname": "algo-1-9w0jk",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "model_dir": "/opt/ml/model",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "module_dir": "s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-25-04-516/source/sourcedir.tar.gz",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "module_name": "train_and_serve",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "network_interface_name": "eth0",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "num_cpus": 2,
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "num_gpus": 0,
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "output_data_dir": "/opt/ml/output/data",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "output_dir": "/opt/ml/output",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "output_intermediate_dir": "/opt/ml/output/intermediate",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "resource_config": {
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         "current_host": "algo-1-9w0jk",
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         "hosts": [
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>             "algo-1-9w0jk"
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>         ]
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     },
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span>     "user_entry_point": "train_and_serve.py"
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> }
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Environment variables:
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_HOSTS=["algo-1-9w0jk"]
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_NETWORK_INTERFACE_NAME=eth0
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_HPS={"estimators":10}
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_USER_ENTRY_POINT=train_and_serve.py
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_FRAMEWORK_PARAMS={}
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_RESOURCE_CONFIG={"current_host":"algo-1-9w0jk","hosts":["algo-1-9w0jk"]}
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_INPUT_DATA_CONFIG={"test":{"TrainingInputMode":"File"},"train":{"TrainingInputMode":"File"}}
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_OUTPUT_DATA_DIR=/opt/ml/output/data
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_CHANNELS=["test","train"]
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_CURRENT_HOST=algo-1-9w0jk
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_MODULE_NAME=train_and_serve
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_LOG_LEVEL=20
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_FRAMEWORK_MODULE=sagemaker_sklearn_container.training:main
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_INPUT_DIR=/opt/ml/input
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_INPUT_CONFIG_DIR=/opt/ml/input/config
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_OUTPUT_DIR=/opt/ml/output
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_NUM_CPUS=2
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_NUM_GPUS=0
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_MODEL_DIR=/opt/ml/model
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-25-04-516/source/sourcedir.tar.gz
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{"test":"/opt/ml/input/data/test","train":"/opt/ml/input/data/train"},"current_host":"algo-1-9w0jk","framework_module":"sagemaker_sklearn_container.training:main","hosts":["algo-1-9w0jk"],"hyperparameters":{"estimators":10},"input_config_dir":"/opt/ml/input/config","input_data_config":{"test":{"TrainingInputMode":"File"},"train":{"TrainingInputMode":"File"}},"input_dir":"/opt/ml/input","is_master":true,"job_name":"sagemaker-scikit-learn-2022-07-17-15-25-04-516","log_level":20,"master_hostname":"algo-1-9w0jk","model_dir":"/opt/ml/model","module_dir":"s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-25-04-516/source/sourcedir.tar.gz","module_name":"train_and_serve","network_interface_name":"eth0","num_cpus":2,"num_gpus":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_host":"algo-1-9w0jk","hosts":["algo-1-9w0jk"]},"user_entry_point":"train_and_serve.py"}
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_USER_ARGS=["--estimators","10"]
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_CHANNEL_TRAIN=/opt/ml/input/data/train
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_CHANNEL_TEST=/opt/ml/input/data/test
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> SM_HP_ESTIMATORS=10
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> PYTHONPATH=/opt/ml/code:/miniconda3/bin:/miniconda3/lib/python38.zip:/miniconda3/lib/python3.8:/miniconda3/lib/python3.8/lib-dynload:/miniconda3/lib/python3.8/site-packages
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> Invoking script with the following command:
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> /miniconda3/bin/python train_and_serve.py --estimators 10
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> command line arguments:  Namespace(estimators=10, sm_channel_test='/opt/ml/input/data/test', sm_channel_train='/opt/ml/input/data/train', sm_model_dir='/opt/ml/model', sm_output_data_dir='/opt/ml/output/data')
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> training_dir: /opt/ml/input/data/train
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> training_dir files list: ['train.csv']
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> testing_dir: /opt/ml/input/data/test
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> testing_dir files list: ['test.csv']
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> sm_model_dir: /opt/ml/model
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> output_data_dir: /opt/ml/output/data
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> X_train.shape: (120, 4)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> y_train.shape: (120,)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> X_train.shape: (30, 4)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> y_train.shape: (30,)
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> sm_model_dir: /opt/ml/model
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> sm_model_dir files list: ['model.joblib']
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> output_data_dir: /opt/ml/output/data
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> output_data_dir files list: ['y_pred.csv', 'output_cm.png']
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk |</span> 2022-07-17 15:25:13,824 sagemaker-containers INFO     Reporting training SUCCESS
<span class="ansi-cyan-fg">ubyi50juw8-algo-1-9w0jk exited with code 0
</span>Aborting on container exit...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Failed to delete: /tmp/tmp9kiuooe_/algo-1-9w0jk Please remove it manually.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>===== Job Complete =====
Attaching to e6h08rxuj4-algo-1-bitrj
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022-07-17 15:25:16,610 INFO - sagemaker-containers - No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022-07-17 15:25:16,614 INFO - sagemaker-containers - No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022-07-17 15:25:16,615 INFO - sagemaker-containers - nginx config: 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> worker_processes auto;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> daemon off;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> pid /tmp/nginx.pid;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> error_log  /dev/stderr;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> worker_rlimit_nofile 4096;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> events {
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   worker_connections 2048;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> }
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> http {
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   include /etc/nginx/mime.types;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   default_type application/octet-stream;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   access_log /dev/stdout combined;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   upstream gunicorn {
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>     server unix:/tmp/gunicorn.sock;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   }
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   server {
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>     listen 8080 deferred;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>     client_max_body_size 0;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>     keepalive_timeout 3;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>     location ~ ^/(ping|invocations|execution-parameters) {
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>       proxy_set_header Host $http_host;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>       proxy_redirect off;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>       proxy_read_timeout 60s;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>       proxy_pass http://gunicorn;
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>     }
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>     location / {
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>       return 404 "{}";
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>     }
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   }
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> }
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022-07-17 15:25:16,826 INFO - sagemaker-containers - Module train_and_serve does not provide a setup.py. 
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Generating setup.py
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022-07-17 15:25:16,826 INFO - sagemaker-containers - Generating setup.cfg
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022-07-17 15:25:16,826 INFO - sagemaker-containers - Generating MANIFEST.in
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022-07-17 15:25:16,826 INFO - sagemaker-containers - Installing module with the following command:
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> /miniconda3/bin/python3 -m pip install . -r requirements.txt
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Processing /opt/ml/code
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Preparing metadata (setup.py) ... done
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Collecting seaborn==0.11.2
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Downloading seaborn-0.11.2-py3-none-any.whl (292 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">292.8/292.8 kB</span> <span class="ansi-red-fg">36.6 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>31m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Requirement already satisfied: numpy&gt;=1.15 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.21.0)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Collecting matplotlib&gt;=2.2
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Downloading matplotlib-3.5.2-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (11.3 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">11.3/11.3 MB</span> <span class="ansi-red-fg">101.9 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:0100:01:--:--
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Requirement already satisfied: scipy&gt;=1.0 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.5.3)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Requirement already satisfied: pandas&gt;=0.23 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.1.3)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Collecting kiwisolver&gt;=1.0.1
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Downloading kiwisolver-1.4.4-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (1.2 MB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">1.2/1.2 MB</span> <span class="ansi-red-fg">94.2 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>31m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Collecting cycler&gt;=0.10
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Downloading cycler-0.11.0-py3-none-any.whl (6.4 kB)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Collecting packaging&gt;=20.0
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Downloading packaging-21.3-py3-none-any.whl (40 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">40.8/40.8 kB</span> <span class="ansi-red-fg">11.9 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>1m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Collecting fonttools&gt;=4.22.0
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Downloading fonttools-4.34.4-py3-none-any.whl (944 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">944.1/944.1 kB</span> <span class="ansi-red-fg">12.1 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:01eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Requirement already satisfied: pillow&gt;=6.2.0 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (9.1.1)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Collecting pyparsing&gt;=2.2.1
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Downloading pyparsing-3.0.9-py3-none-any.whl (98 kB)
     <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">98.3/98.3 kB</span> <span class="ansi-red-fg">27.3 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>1m? eta <span class="ansi-cyan-fg">-:--:--</span>
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Requirement already satisfied: python-dateutil&gt;=2.7 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2.8.1)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Requirement already satisfied: pytz&gt;=2017.2 in /miniconda3/lib/python3.8/site-packages (from pandas&gt;=0.23-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2022.1)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Requirement already satisfied: six&gt;=1.5 in /miniconda3/lib/python3.8/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.15.0)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Building wheels for collected packages: train-and-serve
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Building wheel for train-and-serve (setup.py) ... -2022/07/17 15:25:19 [crit] 14#14: *1 connect() to unix:/tmp/gunicorn.sock failed (2: No such file or directory) while connecting to upstream, client: 172.18.0.1, server: , request: "GET /ping HTTP/1.1", upstream: "http://unix:/tmp/gunicorn.sock:/ping", host: "localhost:8080"
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 172.18.0.1 - - [17/Jul/2022:15:25:19 +0000] "GET /ping HTTP/1.1" 502 182 "-" "python-urllib3/1.26.8"
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>done
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Created wheel for train-and-serve: filename=train_and_serve-1.0.0-py2.py3-none-any.whl size=6682 sha256=f4b6952b904adaa9a17270142b81e0746714104ac88739bf2ba644d15a4fe837
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span>   Stored in directory: /home/model-server/tmp/pip-ephem-wheel-cache-6muul1xe/wheels/f3/75/57/158162e9eab7af12b5c338c279b3a81f103b89d74eeb911c00
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Successfully built train-and-serve
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Installing collected packages: train-and-serve, pyparsing, kiwisolver, fonttools, cycler, packaging, matplotlib, seaborn
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> Successfully installed cycler-0.11.0 fonttools-4.34.4 kiwisolver-1.4.4 matplotlib-3.5.2 packaging-21.3 pyparsing-3.0.9 seaborn-0.11.2 train-and-serve-1.0.0
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> <span class="ansi-yellow-fg">WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</span><span class="ansi-yellow-fg">
</span><span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022/07/17 15:25:24 [crit] 14#14: *3 connect() to unix:/tmp/gunicorn.sock failed (2: No such file or directory) while connecting to upstream, client: 172.18.0.1, server: , request: "GET /ping HTTP/1.1", upstream: "http://unix:/tmp/gunicorn.sock:/ping", host: "localhost:8080"
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 172.18.0.1 - - [17/Jul/2022:15:25:24 +0000] "GET /ping HTTP/1.1" 502 182 "-" "python-urllib3/1.26.8"
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022-07-17 15:25:24,850 INFO - matplotlib.font_manager - generated new fontManager
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> [2022-07-17 15:25:25 +0000] [35] [INFO] Starting gunicorn 20.0.4
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> [2022-07-17 15:25:25 +0000] [35] [INFO] Listening at: unix:/tmp/gunicorn.sock (35)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> [2022-07-17 15:25:25 +0000] [35] [INFO] Using worker: gevent
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> [2022-07-17 15:25:25 +0000] [37] [INFO] Booting worker with pid: 37
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> [2022-07-17 15:25:25 +0000] [38] [INFO] Booting worker with pid: 38
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022-07-17 15:25:29,802 INFO - sagemaker-containers - No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> model_fn model_dir: /opt/ml/model
!<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 172.18.0.1 - - [17/Jul/2022:15:25:31 +0000] "GET /ping HTTP/1.1" 200 0 "-" "python-urllib3/1.26.8"
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_endpoint_name</span> <span class="o">=</span> <span class="n">sk_predictor</span><span class="o">.</span><span class="n">endpoint_name</span>
<span class="n">sk_endpoint_name</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'sagemaker-scikit-learn-2022-07-17-15-25-14-401'</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># send JSON request to endpoint</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">session_local</span><span class="o">.</span><span class="n">sagemaker_runtime_client</span>

<span class="n">request_body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Input"</span><span class="p">:</span> <span class="p">[[</span><span class="mf">9.0</span><span class="p">,</span> <span class="mi">3571</span><span class="p">,</span> <span class="mi">1976</span><span class="p">,</span> <span class="mf">0.525</span><span class="p">]]}</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">request_body</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">invoke_endpoint</span><span class="p">(</span>
    <span class="n">EndpointName</span><span class="o">=</span><span class="n">sk_endpoint_name</span><span class="p">,</span> <span class="n">ContentType</span><span class="o">=</span><span class="s2">"application/json"</span><span class="p">,</span> <span class="n">Body</span><span class="o">=</span><span class="n">payload</span>
<span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">"Body"</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())[</span><span class="s2">"Output"</span><span class="p">]</span>
<span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 2022-07-17 15:25:31,439 INFO - sagemaker-containers - No GPUs detected (normal if no gpus installed)
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> model_fn model_dir: /opt/ml/model
<span class="ansi-cyan-fg">e6h08rxuj4-algo-1-bitrj |</span> 172.18.0.1 - - [17/Jul/2022:15:25:32 +0000] "POST /invocations HTTP/1.1" 200 13 "-" "python-urllib3/1.26.8"
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>2</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># get JSON response from endpoint</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Predicted class category </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">categories_map</span><span class="p">[</span><span class="n">result</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Predicted class category 2 (Iris-virginica)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Make sure we delete the endpoint once we have tested our deployed model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_predictor</span><span class="o">.</span><span class="n">delete_endpoint</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Gracefully stopping... (press Ctrl+C again to force)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="SKLearn-model-training-and-serving-in-SageMaker-managed-environment">
<a class="anchor" href="#SKLearn-model-training-and-serving-in-SageMaker-managed-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>SKLearn model training and serving in SageMaker managed environment<a class="anchor-link" href="#SKLearn-model-training-and-serving-in-SageMaker-managed-environment"> </a>
</h1>
<p>Now that our script is complete and we have tested it in a local environment, let's proceed to train and deploy it in Amazon SageMaker managed environment. Moving from a local environment to managed environment is very simple. We only need to change the instance type.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># train and deploy model with input and output as JSON objects</span>
<span class="n">sk_estimator</span> <span class="o">=</span> <span class="n">SKLearn</span><span class="p">(</span>
    <span class="n">entry_point</span><span class="o">=</span><span class="n">script_file_name</span><span class="p">,</span>
    <span class="n">source_dir</span><span class="o">=</span><span class="n">script_path</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">custom_library_path</span><span class="p">],</span>
    <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'ml.m5.large'</span><span class="p">,</span>
    <span class="n">framework_version</span><span class="o">=</span><span class="s2">"1.0-1"</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span><span class="s2">"estimators"</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">sk_estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">({</span><span class="s2">"train"</span><span class="p">:</span> <span class="n">s3_train_uri</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">:</span> <span class="n">s3_test_uri</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2022-07-17 15:25:33 Starting - Starting the training job...
2022-07-17 15:25:57 Starting - Preparing the instances for trainingProfilerReport-1658071533: InProgress
.........
2022-07-17 15:27:17 Downloading - Downloading input data...
2022-07-17 15:27:57 Training - Downloading the training image...
2022-07-17 15:28:35 Training - Training image download completed. Training in progress...<span class="ansi-blue-fg">2022-07-17 15:28:37,458 sagemaker-containers INFO     Imported framework sagemaker_sklearn_container.training</span>
<span class="ansi-blue-fg">2022-07-17 15:28:37,462 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)</span>
<span class="ansi-blue-fg">2022-07-17 15:28:37,478 sagemaker_sklearn_container.training INFO     Invoking user training script.</span>
<span class="ansi-blue-fg">2022-07-17 15:28:37,948 sagemaker-training-toolkit INFO     Installing dependencies from requirements.txt:</span>
<span class="ansi-blue-fg">/miniconda3/bin/python -m pip install -r requirements.txt</span>
<span class="ansi-blue-fg">Collecting seaborn==0.11.2
  Downloading seaborn-0.11.2-py3-none-any.whl (292 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 292.8/292.8 kB 11.5 MB/s eta 0:00:00</span>
<span class="ansi-blue-fg">Requirement already satisfied: numpy&gt;=1.15 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.21.0)</span>
<span class="ansi-blue-fg">Collecting matplotlib&gt;=2.2
  Downloading matplotlib-3.5.2-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (11.3 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 11.3/11.3 MB 69.0 MB/s eta 0:00:00</span>
<span class="ansi-blue-fg">Requirement already satisfied: scipy&gt;=1.0 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.5.3)</span>
<span class="ansi-blue-fg">Requirement already satisfied: pandas&gt;=0.23 in /miniconda3/lib/python3.8/site-packages (from seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.1.3)</span>
<span class="ansi-blue-fg">Requirement already satisfied: pillow&gt;=6.2.0 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (9.1.1)</span>
<span class="ansi-blue-fg">Requirement already satisfied: python-dateutil&gt;=2.7 in /miniconda3/lib/python3.8/site-packages (from matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2.8.1)</span>
<span class="ansi-blue-fg">Collecting kiwisolver&gt;=1.0.1
  Downloading kiwisolver-1.4.4-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (1.2 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1.2/1.2 MB 37.9 MB/s eta 0:00:00</span>
<span class="ansi-blue-fg">Collecting packaging&gt;=20.0
  Downloading packaging-21.3-py3-none-any.whl (40 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 40.8/40.8 kB 7.4 MB/s eta 0:00:00</span>
<span class="ansi-blue-fg">Collecting cycler&gt;=0.10
  Downloading cycler-0.11.0-py3-none-any.whl (6.4 kB)</span>
<span class="ansi-blue-fg">Collecting pyparsing&gt;=2.2.1
  Downloading pyparsing-3.0.9-py3-none-any.whl (98 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 98.3/98.3 kB 18.2 MB/s eta 0:00:00</span>
<span class="ansi-blue-fg">Collecting fonttools&gt;=4.22.0
  Downloading fonttools-4.34.4-py3-none-any.whl (944 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 944.1/944.1 kB 52.9 MB/s eta 0:00:00</span>
<span class="ansi-blue-fg">Requirement already satisfied: pytz&gt;=2017.2 in /miniconda3/lib/python3.8/site-packages (from pandas&gt;=0.23-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (2022.1)</span>
<span class="ansi-blue-fg">Requirement already satisfied: six&gt;=1.5 in /miniconda3/lib/python3.8/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib&gt;=2.2-&gt;seaborn==0.11.2-&gt;-r requirements.txt (line 2)) (1.15.0)</span>
<span class="ansi-blue-fg">Installing collected packages: pyparsing, kiwisolver, fonttools, cycler, packaging, matplotlib, seaborn</span>
<span class="ansi-blue-fg">Successfully installed cycler-0.11.0 fonttools-4.34.4 kiwisolver-1.4.4 matplotlib-3.5.2 packaging-21.3 pyparsing-3.0.9 seaborn-0.11.2</span>
<span class="ansi-blue-fg">WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv</span>
<span class="ansi-blue-fg">2022-07-17 15:28:44,790 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)</span>
<span class="ansi-blue-fg">2022-07-17 15:28:44,810 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)</span>
<span class="ansi-blue-fg">2022-07-17 15:28:44,831 sagemaker-training-toolkit INFO     No GPUs detected (normal if no gpus installed)</span>
<span class="ansi-blue-fg">2022-07-17 15:28:44,847 sagemaker-training-toolkit INFO     Invoking user script</span>
<span class="ansi-blue-fg">Training Env:</span>
<span class="ansi-blue-fg">{
    "additional_framework_parameters": {},
    "channel_input_dirs": {
        "test": "/opt/ml/input/data/test",
        "train": "/opt/ml/input/data/train"
    },
    "current_host": "algo-1",
    "framework_module": "sagemaker_sklearn_container.training:main",
    "hosts": [
        "algo-1"
    ],
    "hyperparameters": {
        "estimators": 10
    },
    "input_config_dir": "/opt/ml/input/config",
    "input_data_config": {
        "test": {
            "TrainingInputMode": "File",
            "S3DistributionType": "FullyReplicated",
            "RecordWrapperType": "None"
        },
        "train": {
            "TrainingInputMode": "File",
            "S3DistributionType": "FullyReplicated",
            "RecordWrapperType": "None"
        }
    },
    "input_dir": "/opt/ml/input",
    "is_master": true,
    "job_name": "sagemaker-scikit-learn-2022-07-17-15-25-33-210",
    "log_level": 20,
    "master_hostname": "algo-1",
    "model_dir": "/opt/ml/model",
    "module_dir": "s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-25-33-210/source/sourcedir.tar.gz",
    "module_name": "train_and_serve",
    "network_interface_name": "eth0",
    "num_cpus": 2,
    "num_gpus": 0,
    "output_data_dir": "/opt/ml/output/data",
    "output_dir": "/opt/ml/output",
    "output_intermediate_dir": "/opt/ml/output/intermediate",
    "resource_config": {
        "current_host": "algo-1",
        "current_instance_type": "ml.m5.large",
        "current_group_name": "homogeneousCluster",
        "hosts": [
            "algo-1"
        ],
        "instance_groups": [
            {
                "instance_group_name": "homogeneousCluster",
                "instance_type": "ml.m5.large",
                "hosts": [
                    "algo-1"
                ]
            }
        ],
        "network_interface_name": "eth0"
    },
    "user_entry_point": "train_and_serve.py"</span>
<span class="ansi-blue-fg">}</span>
<span class="ansi-blue-fg">Environment variables:</span>
<span class="ansi-blue-fg">SM_HOSTS=["algo-1"]</span>
<span class="ansi-blue-fg">SM_NETWORK_INTERFACE_NAME=eth0</span>
<span class="ansi-blue-fg">SM_HPS={"estimators":10}</span>
<span class="ansi-blue-fg">SM_USER_ENTRY_POINT=train_and_serve.py</span>
<span class="ansi-blue-fg">SM_FRAMEWORK_PARAMS={}</span>
<span class="ansi-blue-fg">SM_RESOURCE_CONFIG={"current_group_name":"homogeneousCluster","current_host":"algo-1","current_instance_type":"ml.m5.large","hosts":["algo-1"],"instance_groups":[{"hosts":["algo-1"],"instance_group_name":"homogeneousCluster","instance_type":"ml.m5.large"}],"network_interface_name":"eth0"}</span>
<span class="ansi-blue-fg">SM_INPUT_DATA_CONFIG={"test":{"RecordWrapperType":"None","S3DistributionType":"FullyReplicated","TrainingInputMode":"File"},"train":{"RecordWrapperType":"None","S3DistributionType":"FullyReplicated","TrainingInputMode":"File"}}</span>
<span class="ansi-blue-fg">SM_OUTPUT_DATA_DIR=/opt/ml/output/data</span>
<span class="ansi-blue-fg">SM_CHANNELS=["test","train"]</span>
<span class="ansi-blue-fg">SM_CURRENT_HOST=algo-1</span>
<span class="ansi-blue-fg">SM_MODULE_NAME=train_and_serve</span>
<span class="ansi-blue-fg">SM_LOG_LEVEL=20</span>
<span class="ansi-blue-fg">SM_FRAMEWORK_MODULE=sagemaker_sklearn_container.training:main</span>
<span class="ansi-blue-fg">SM_INPUT_DIR=/opt/ml/input</span>
<span class="ansi-blue-fg">SM_INPUT_CONFIG_DIR=/opt/ml/input/config</span>
<span class="ansi-blue-fg">SM_OUTPUT_DIR=/opt/ml/output</span>
<span class="ansi-blue-fg">SM_NUM_CPUS=2</span>
<span class="ansi-blue-fg">SM_NUM_GPUS=0</span>
<span class="ansi-blue-fg">SM_MODEL_DIR=/opt/ml/model</span>
<span class="ansi-blue-fg">SM_MODULE_DIR=s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-25-33-210/source/sourcedir.tar.gz</span>
<span class="ansi-blue-fg">SM_TRAINING_ENV={"additional_framework_parameters":{},"channel_input_dirs":{"test":"/opt/ml/input/data/test","train":"/opt/ml/input/data/train"},"current_host":"algo-1","framework_module":"sagemaker_sklearn_container.training:main","hosts":["algo-1"],"hyperparameters":{"estimators":10},"input_config_dir":"/opt/ml/input/config","input_data_config":{"test":{"RecordWrapperType":"None","S3DistributionType":"FullyReplicated","TrainingInputMode":"File"},"train":{"RecordWrapperType":"None","S3DistributionType":"FullyReplicated","TrainingInputMode":"File"}},"input_dir":"/opt/ml/input","is_master":true,"job_name":"sagemaker-scikit-learn-2022-07-17-15-25-33-210","log_level":20,"master_hostname":"algo-1","model_dir":"/opt/ml/model","module_dir":"s3://sagemaker-us-east-1-801598032724/sagemaker-scikit-learn-2022-07-17-15-25-33-210/source/sourcedir.tar.gz","module_name":"train_and_serve","network_interface_name":"eth0","num_cpus":2,"num_gpus":0,"output_data_dir":"/opt/ml/output/data","output_dir":"/opt/ml/output","output_intermediate_dir":"/opt/ml/output/intermediate","resource_config":{"current_group_name":"homogeneousCluster","current_host":"algo-1","current_instance_type":"ml.m5.large","hosts":["algo-1"],"instance_groups":[{"hosts":["algo-1"],"instance_group_name":"homogeneousCluster","instance_type":"ml.m5.large"}],"network_interface_name":"eth0"},"user_entry_point":"train_and_serve.py"}</span>
<span class="ansi-blue-fg">SM_USER_ARGS=["--estimators","10"]</span>
<span class="ansi-blue-fg">SM_OUTPUT_INTERMEDIATE_DIR=/opt/ml/output/intermediate</span>
<span class="ansi-blue-fg">SM_CHANNEL_TEST=/opt/ml/input/data/test</span>
<span class="ansi-blue-fg">SM_CHANNEL_TRAIN=/opt/ml/input/data/train</span>
<span class="ansi-blue-fg">SM_HP_ESTIMATORS=10</span>
<span class="ansi-blue-fg">PYTHONPATH=/opt/ml/code:/miniconda3/bin:/miniconda3/lib/python38.zip:/miniconda3/lib/python3.8:/miniconda3/lib/python3.8/lib-dynload:/miniconda3/lib/python3.8/site-packages</span>
<span class="ansi-blue-fg">Invoking script with the following command:</span>
<span class="ansi-blue-fg">/miniconda3/bin/python train_and_serve.py --estimators 10</span>
<span class="ansi-blue-fg">command line arguments:  Namespace(estimators=10, sm_channel_test='/opt/ml/input/data/test', sm_channel_train='/opt/ml/input/data/train', sm_model_dir='/opt/ml/model', sm_output_data_dir='/opt/ml/output/data')</span>
<span class="ansi-blue-fg">training_dir: /opt/ml/input/data/train</span>
<span class="ansi-blue-fg">training_dir files list: ['train.csv']</span>
<span class="ansi-blue-fg">testing_dir: /opt/ml/input/data/test</span>
<span class="ansi-blue-fg">testing_dir files list: ['test.csv']</span>
<span class="ansi-blue-fg">sm_model_dir: /opt/ml/model</span>
<span class="ansi-blue-fg">output_data_dir: /opt/ml/output/data</span>
<span class="ansi-blue-fg">X_train.shape: (120, 4)</span>
<span class="ansi-blue-fg">y_train.shape: (120,)</span>
<span class="ansi-blue-fg">X_train.shape: (30, 4)</span>
<span class="ansi-blue-fg">y_train.shape: (30,)</span>
<span class="ansi-blue-fg">sm_model_dir: /opt/ml/model</span>
<span class="ansi-blue-fg">sm_model_dir files list: ['model.joblib']</span>
<span class="ansi-blue-fg">output_data_dir: /opt/ml/output/data</span>
<span class="ansi-blue-fg">output_data_dir files list: ['y_pred.csv', 'output_cm.png']</span>
<span class="ansi-blue-fg">2022-07-17 15:28:48,476 sagemaker-containers INFO     Reporting training SUCCESS</span>

2022-07-17 15:28:58 Uploading - Uploading generated training model
2022-07-17 15:29:18 Completed - Training job completed
Training seconds: 116
Billable seconds: 116
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/myblog/images/copied_from_nb/images/2022-07-07-sagemaker-script-mode/sklearn-managed-done.png" alt="sklearn-managed-done"></p>
<p>We have used AWS managed <code>ml.m5.large</code> instance for training. Once the training job is complete, model artifacts are uploaded to the S3 bucket. In the end, it also shows the billable seconds.</p>
<p>Let's confirm that the session we are using is not local.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_estimator</span><span class="o">.</span><span class="n">sagemaker_session</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;sagemaker.session.Session at 0x7f80a7d15700&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now deploy it on SageMaker managed <code>ml.t2.medium</code> instance.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_predictor</span> <span class="o">=</span> <span class="n">sk_estimator</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span>
    <span class="n">initial_instance_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="s1">'ml.t2.medium'</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>-------------!</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Test deployed model with a sample request.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># send JSON request to endpoint</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">sagemaker_runtime_client</span>

<span class="n">request_body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Input"</span><span class="p">:</span> <span class="p">[[</span><span class="mf">9.0</span><span class="p">,</span> <span class="mi">3571</span><span class="p">,</span> <span class="mi">1976</span><span class="p">,</span> <span class="mf">0.525</span><span class="p">]]}</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">request_body</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">invoke_endpoint</span><span class="p">(</span>
    <span class="n">EndpointName</span><span class="o">=</span><span class="n">sk_predictor</span><span class="o">.</span><span class="n">endpoint_name</span><span class="p">,</span>
    <span class="n">ContentType</span><span class="o">=</span><span class="s2">"application/json"</span><span class="p">,</span>
    <span class="n">Body</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">"Body"</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())[</span><span class="s2">"Output"</span><span class="p">]</span>
<span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>2</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># get JSON response from endpoint</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Predicted class category </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">categories_map</span><span class="p">[</span><span class="n">result</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Predicted class category 2 (Iris-virginica)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Again, don't forget to delete the endpoint once we are done with testing.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sk_predictor</span><span class="o">.</span><span class="n">delete_endpoint</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js" repo="hassaanbinaslam/myblog" issue-term="title" label="blogpost-comment" theme="github-light" crossorigin="anonymous" async>
</script><a class="u-url" href="/myblog/aws/ml/sagemaker/2022/07/07/sagemaker-script-mode.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/myblog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/myblog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/myblog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>A log of my mistakes, thoughts, and learning.</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list">
<li><a rel="me" href="https://github.com/hassaanbinaslam" target="_blank" title="hassaanbinaslam"><svg class="svg-icon grey"><use xlink:href="/myblog/assets/minima-social-icons.svg#github"></use></svg></a></li>
<li><a rel="me" href="https://twitter.com/hassaanbinaslam" target="_blank" title="hassaanbinaslam"><svg class="svg-icon grey"><use xlink:href="/myblog/assets/minima-social-icons.svg#twitter"></use></svg></a></li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
